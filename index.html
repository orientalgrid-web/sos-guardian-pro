<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ°Ô∏è SOS Guardian Pro - Emergency Safety</title>
    <!-- We'll use OpenStreetMap instead of Mapbox -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: #0c0e2a; color: #fff; min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        .header {
            background: linear-gradient(90deg, #008751 0%, #00A859 100%);
            padding: 25px 30px; border-radius: 20px; margin-bottom: 20px;
            text-align: center; box-shadow: 0 15px 35px rgba(0, 135, 81, 0.3);
        }
        
        .demo-warning {
            background: #ff3b30; color: white; padding: 15px; border-radius: 15px;
            margin: 20px 0; text-align: center; font-weight: bold;
            border: 2px solid #ff9500;
        }
        
        .emergency-section {
            text-align: center; margin: 30px 0; padding: 30px;
            background: rgba(255, 255, 255, 0.05); border-radius: 25px;
        }
        
        .emergency-btn {
            background: linear-gradient(45deg, #ff3b30, #ff2d55); color: white;
            border: none; width: 250px; height: 250px; border-radius: 50%;
            margin: 0 auto 20px; cursor: pointer; font-size: 24px; font-weight: bold;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 20px 40px rgba(255, 59, 48, 0.4);
            animation: heartbeat 2s infinite;
        }
        
        @keyframes heartbeat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        
        .shake-status {
            background: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 15px;
            margin: 20px auto; max-width: 500px; display: flex; align-items: center;
            justify-content: center; gap: 15px;
        }
        
        .map-container {
            height: 400px; border-radius: 20px; overflow: hidden; margin: 30px 0;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
        }
        
        #map {
            width: 100%; height: 100%; border-radius: 20px;
        }
        
        .map-overlay {
            position: absolute; top: 20px; left: 20px; background: rgba(0, 0, 0, 0.7);
            padding: 15px; border-radius: 15px; z-index: 1000; max-width: 300px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .quick-actions {
            position: fixed; bottom: 20px; right: 20px; background: rgba(0, 0, 0, 0.9);
            padding: 15px; border-radius: 15px; z-index: 1000; min-width: 200px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .action-btn {
            background: #2196F3; color: white; border: none; padding: 10px 15px;
            border-radius: 8px; margin: 5px 0; width: 100%; font-size: 14px; cursor: pointer;
        }
        
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); z-index: 1000; align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: #1a1f3a; width: 90%; max-width: 500px; border-radius: 25px;
            padding: 40px; text-align: center; border: 2px solid rgba(255, 59, 48, 0.5);
        }
        
        .notification {
            position: fixed; bottom: 20px; left: 20px; background: rgba(0, 0, 0, 0.9);
            color: white; padding: 15px 25px; border-radius: 15px; z-index: 100;
            max-width: 350px; animation: slideIn 0.5s ease-out;
            border-left: 5px solid #008751;
        }
        
        @keyframes slideIn {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @media (max-width: 768px) {
            .emergency-btn { width: 200px; height: 200px; font-size: 20px; }
            .quick-actions { bottom: 10px; right: 10px; left: 10px; width: auto; }
            .map-container { height: 300px; }
        }
        
        .hidden { display: none; }
        
        /* Leaflet map fixes */
        .leaflet-container { 
            font-family: inherit !important;
            background: #1a1f3a !important;
        }
        
        .leaflet-control-attribution {
            background: rgba(0, 0, 0, 0.7) !important;
            color: white !important;
        }
        
        .leaflet-control-attribution a {
            color: #00ff88 !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- DEMO WARNING -->
        <div class="demo-warning">
            <i class="fas fa-exclamation-triangle"></i> DEMO VERSION - Safe for testing
        </div>
        
        <!-- HEADER -->
        <div class="header">
            <h1><i class="fas fa-shield-alt"></i> SOS Guardian Pro</h1>
            <p>Emergency Safety System for Nigeria</p>
        </div>
        
        <!-- SHAKE DETECTION -->
        <div class="shake-status">
            <div class="shake-count" style="background:#007aff;color:white;width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;">
                0/6
            </div>
            <div class="shake-text">
                <span style="color:#ff9500;font-weight:600;">SHAKE TO ACTIVATE:</span> Shake phone 6 times
            </div>
        </div>
        
        <!-- EMERGENCY SECTION -->
        <div class="emergency-section">
            <h2>EMERGENCY SOS</h2>
            <p>Press and hold for 3 seconds or shake phone 6 times</p>
            
            <button class="emergency-btn" id="sosButton">
                <i class="fas fa-bell"></i>
                <span id="buttonText">EMERGENCY<br>SOS</span>
                <div id="countdown" class="hidden" style="font-size:50px;font-weight:800;"></div>
            </button>
            
            <p style="color:#ffcc00;">Hold button or shake phone</p>
        </div>
        
        <!-- MAP CONTAINER -->
        <div class="map-container">
            <div class="map-overlay">
                <h3><i class="fas fa-satellite"></i> LIVE TRACKING</h3>
                <p>Your current location<br>
                <span style="color:#00ff88;">‚Ä¢ GPS ACTIVE</span> | <span style="color:#00ff88;">‚Ä¢ DEMO MODE</span></p>
            </div>
            <div id="map"></div>
        </div>
        
        <!-- SIMPLE FEATURES -->
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin:30px 0;">
            <div style="background:rgba(255,255,255,0.05);padding:20px;border-radius:15px;text-align:center;">
                <div style="background:#008751;width:60px;height:60px;border-radius:15px;display:flex;align-items:center;justify-content:center;margin:0 auto 15px;font-size:25px;">
                    <i class="fas fa-location-dot"></i>
                </div>
                <h3>GPS Tracking</h3>
                <p>Real-time location sharing</p>
            </div>
            
            <div style="background:rgba(255,255,255,0.05);padding:20px;border-radius:15px;text-align:center;">
                <div style="background:#008751;width:60px;height:60px;border-radius:15px;display:flex;align-items:center;justify-content:center;margin:0 auto 15px;font-size:25px;">
                    <i class="fab fa-whatsapp"></i>
                </div>
                <h3>WhatsApp Alerts</h3>
                <p>Share emergency alerts</p>
            </div>
            
            <div style="background:rgba(255,255,255,0.05);padding:20px;border-radius:15px;text-align:center;">
                <div style="background:#008751;width:60px;height:60px;border-radius:15px;display:flex;align-items:center;justify-content:center;margin:0 auto 15px;font-size:25px;">
                    <i class="fas fa-camera"></i>
                </div>
                <h3>Photo Evidence</h3>
                <p>Capture emergency photos</p>
            </div>
        </div>
        
        <!-- FOOTER -->
        <div style="text-align:center;padding:30px;margin-top:30px;background:rgba(0,0,0,0.3);border-radius:15px;">
            <p>SOS Guardian Pro v2.0 - DEMO MODE</p>
            <p>Emergency: 112, 767 | Demo only</p>
        </div>
    </div>
    
    <!-- QUICK ACTIONS -->
    <div class="quick-actions">
        <h4 style="color:#FFD700;margin:0 0 10px 0;font-size:14px;">Quick Actions:</h4>
        <button class="action-btn" onclick="shareViaWhatsApp()" style="background:#25D366;">
            <i class="fab fa-whatsapp"></i> WhatsApp Alert
        </button>
        <button class="action-btn" onclick="capturePhoto()" style="background:#9C27B0;">
            <i class="fas fa-camera"></i> Photo Evidence
        </button>
        <button class="action-btn" onclick="shareLocation()" style="background:#4CAF50;">
            <i class="fas fa-map-marker-alt"></i> Share Location
        </button>
    </div>
    
    <!-- EMERGENCY MODAL -->
    <div class="modal" id="emergencyModal">
        <div class="modal-content">
            <div style="font-size:70px;color:#ff3b30;margin-bottom:20px;">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h2 style="color:#ffcc00;">EMERGENCY ACTIVATED!</h2>
            <p>Click buttons below to share alerts</p>
            <div style="margin:30px 0;">
                <button onclick="shareViaWhatsApp()" style="background:#25D366;color:white;border:none;padding:15px;border-radius:10px;margin:5px;width:100%;">
                    <i class="fab fa-whatsapp"></i> Share via WhatsApp
                </button>
                <button onclick="shareLocation()" style="background:#2196F3;color:white;border:none;padding:15px;border-radius:10px;margin:5px;width:100%;">
                    <i class="fas fa-map-marker-alt"></i> Share Location
                </button>
                <button onclick="capturePhoto()" style="background:#9C27B0;color:white;border:none;padding:15px;border-radius:10px;margin:5px;width:100%;">
                    <i class="fas fa-camera"></i> Take Photo Evidence
                </button>
            </div>
            <button onclick="closeModal()" style="background:#666;color:white;border:none;padding:15px;border-radius:10px;width:100%;">
                Cancel (False Alarm)
            </button>
        </div>
    </div>
    
    <script>
        // ========== CONFIG ==========
        const CONFIG = {
            requiredShakes: 6
        };
        
        // ========== STATE ==========
        let emergencyActive = false;
        let shakeCount = 0;
        let userLocation = { lat: 6.5244, lng: 3.3792 }; // Lagos, Nigeria
        let map = null;
        let marker = null;
        let circle = null;
        
        // ========== INITIALIZE MAP ==========
        function initializeMap() {
            try {
                // Create map centered on Lagos
                map = L.map('map').setView([userLocation.lat, userLocation.lng], 14);
                
                // Add OpenStreetMap tiles (FREE, no API key needed)
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19,
                }).addTo(map);
                
                // Add marker for user location
                marker = L.marker([userLocation.lat, userLocation.lng], {
                    icon: L.divIcon({
                        html: '<div style="background:#ff3b30;width:20px;height:20px;border-radius:50%;border:3px solid white;box-shadow:0 0 10px red;"></div>',
                        iconSize: [26, 26],
                        className: 'emergency-marker'
                    })
                }).addTo(map);
                
                // Add tracking circle
                circle = L.circle([userLocation.lat, userLocation.lng], {
                    color: '#FFD700',
                    fillColor: '#008751',
                    fillOpacity: 0.15,
                    radius: 500 // 500 meters radius
                }).addTo(map);
                
                // Add map controls
                L.control.scale().addTo(map);
                
                console.log('Map initialized successfully');
                showNotification('üó∫Ô∏è Map loaded successfully', 'success');
                
            } catch (error) {
                console.error('Map initialization error:', error);
                showNotification('üó∫Ô∏è Map loading failed - Using simple display', 'error');
                
                // Fallback: Show simple text in map container
                document.getElementById('map').innerHTML = `
                    <div style="display:flex;align-items:center;justify-content:center;height:100%;background:#1a1f3a;color:#ffcc00;text-align:center;padding:20px;">
                        <div>
                            <i class="fas fa-map-marker-alt" style="font-size:50px;margin-bottom:20px;"></i>
                            <h3>GPS Location Tracking</h3>
                            <p>Latitude: ${userLocation.lat.toFixed(6)}</p>
                            <p>Longitude: ${userLocation.lng.toFixed(6)}</p>
                            <p style="margin-top:20px;color:#00ff88;">üìç Location tracking active</p>
                        </div>
                    </div>
                `;
            }
        }
        
        // ========== UPDATE MAP LOCATION ==========
        function updateMapLocation(lat, lng) {
            userLocation = { lat, lng };
            
            if (map && marker) {
                // Smoothly move map to new location
                map.setView([lat, lng], 16, {
                    animate: true,
                    duration: 1
                });
                
                // Update marker position
                marker.setLatLng([lat, lng]);
                
                // Update circle position
                if (circle) {
                    circle.setLatLng([lat, lng]);
                }
                
                // Add a pulsing effect for emergency
                if (emergencyActive) {
                    const pulseCircle = L.circle([lat, lng], {
                        color: '#ff3b30',
                        fillColor: '#ff3b30',
                        fillOpacity: 0.2,
                        radius: 100
                    }).addTo(map);
                    
                    // Remove pulse circle after 3 seconds
                    setTimeout(() => {
                        map.removeLayer(pulseCircle);
                    }, 3000);
                }
            }
        }
        
        // ========== GET USER LOCATION ==========
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        updateMapLocation(lat, lng);
                        showNotification('üìç GPS location acquired', 'success');
                    },
                    (error) => {
                        console.log('Geolocation error:', error.message);
                        showNotification('üìç Using Lagos default location', 'info');
                        
                        // Use default location
                        updateMapLocation(userLocation.lat, userLocation.lng);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            } else {
                showNotification('üìç Geolocation not supported', 'error');
                updateMapLocation(userLocation.lat, userLocation.lng);
            }
        }
        
        // ========== SHAKE DETECTION ==========
        let lastAcceleration = { x: null, y: null, z: null };
        const SHAKE_THRESHOLD = 15;
        
        function handleShake(event) {
            const acceleration = event.accelerationIncludingGravity;
            
            if (!lastAcceleration.x) {
                lastAcceleration = {
                    x: acceleration.x,
                    y: acceleration.y,
                    z: acceleration.z
                };
                return;
            }
            
            const deltaX = Math.abs(acceleration.x - lastAcceleration.x);
            const deltaY = Math.abs(acceleration.y - lastAcceleration.y);
            const deltaZ = Math.abs(acceleration.z - lastAcceleration.z);
            
            if (deltaX + deltaY + deltaZ > SHAKE_THRESHOLD) {
                const now = Date.now();
                if (now - lastShakeTime > 1000) {
                    shakeCount = 0;
                }
                
                shakeCount++;
                lastShakeTime = now;
                
                updateShakeDisplay();
                
                if (shakeCount >= CONFIG.requiredShakes) {
                    triggerEmergency('shake');
                }
            }
            
            lastAcceleration = {
                x: acceleration.x,
                y: acceleration.y,
                z: acceleration.z
            };
        }
        
        function updateShakeDisplay() {
            const shakeElement = document.querySelector('.shake-count');
            const shakeText = document.querySelector('.shake-warning');
            
            if (shakeElement) {
                shakeElement.textContent = `${shakeCount}/${CONFIG.requiredShakes}`;
                
                if (shakeCount >= CONFIG.requiredShakes) {
                    shakeElement.style.background = '#ff3b30';
                    shakeText.textContent = 'EMERGENCY ACTIVATED!';
                } else if (shakeCount >= 4) {
                    shakeElement.style.background = '#ff9500';
                    shakeText.textContent = `SHAKE ${CONFIG.requiredShakes - shakeCount} MORE TIMES`;
                }
            }
        }
        
        // ========== EMERGENCY BUTTON ==========
        const sosButton = document.getElementById('sosButton');
        let holdTimer = null;
        let countdownValue = 3;
        
        sosButton.addEventListener('mousedown', startHoldTimer);
        sosButton.addEventListener('touchstart', startHoldTimer);
        
        sosButton.addEventListener('mouseup', cancelHoldTimer);
        sosButton.addEventListener('touchend', cancelHoldTimer);
        sosButton.addEventListener('mouseleave', cancelHoldTimer);
        
        function startHoldTimer() {
            if (emergencyActive) return;
            
            countdownValue = 3;
            document.getElementById('buttonText').classList.add('hidden');
            document.getElementById('countdown').classList.remove('hidden');
            document.getElementById('countdown').textContent = countdownValue;
            sosButton.style.animation = 'none';
            sosButton.style.transform = 'scale(0.98)';
            
            holdTimer = setInterval(() => {
                countdownValue--;
                document.getElementById('countdown').textContent = countdownValue;
                
                if (countdownValue <= 0) {
                    clearInterval(holdTimer);
                    triggerEmergency('button');
                }
            }, 1000);
        }
        
        function cancelHoldTimer() {
            if (holdTimer && !emergencyActive) {
                clearInterval(holdTimer);
                document.getElementById('buttonText').classList.remove('hidden');
                document.getElementById('countdown').classList.add('hidden');
                sosButton.style.animation = 'heartbeat 2s infinite';
                sosButton.style.transform = 'scale(1)';
            }
        }
        
        // ========== TRIGGER EMERGENCY ==========
        function triggerEmergency(source) {
            if (emergencyActive) return;
            
            emergencyActive = true;
            sosButton.style.background = 'linear-gradient(45deg, #4cd964, #34c759)';
            sosButton.style.animation = 'none';
            document.getElementById('buttonText').classList.add('hidden');
            document.getElementById('countdown').classList.add('hidden');
            
            // Show emergency modal
            document.getElementById('emergencyModal').style.display = 'flex';
            
            // Get current location for emergency
            getLocation();
            
            // Visual emergency effect on map
            if (map && marker) {
                // Make marker pulse
                const emergencyIcon = L.divIcon({
                    html: '<div style="background:#ff3b30;width:30px;height:30px;border-radius:50%;border:5px solid white;box-shadow:0 0 20px red;animation:pulse 1s infinite;"></div>',
                    iconSize: [40, 40],
                    className: 'emergency-marker'
                });
                marker.setIcon(emergencyIcon);
                
                // Add emergency circle
                L.circle([userLocation.lat, userLocation.lng], {
                    color: '#ff3b30',
                    fillColor: '#ff3b30',
                    fillOpacity: 0.1,
                    radius: 200
                }).addTo(map);
            }
            
            showNotification('üö® EMERGENCY PROTOCOL ACTIVATED', 'emergency');
            console.log(`Emergency activated via ${source}`);
        }
        
        // ========== EMERGENCY FEATURES ==========
        function shareViaWhatsApp() {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude.toFixed(6);
                    const lng = position.coords.longitude.toFixed(6);
                    const mapsUrl = `https://maps.google.com/?q=${lat},${lng}`;
                    
                    const message = `üö® EMERGENCY ALERT from SOS Guardian Pro!\n\nüìç Location: ${lat}, ${lng}\nüó∫Ô∏è Map: ${mapsUrl}\nüïí Time: ${new Date().toLocaleString()}\nüë§ User: SOS Guardian User\n\nUser needs emergency assistance!`;
                    
                    const encodedMessage = encodeURIComponent(message);
                    const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
                    
                    window.open(whatsappUrl, '_blank');
                    showNotification('üì± Opening WhatsApp to share emergency alert', 'success');
                },
                () => {
                    // Fallback without location
                    const fallbackMessage = `üö® EMERGENCY ALERT from SOS Guardian Pro!\n\nüìç Location: GPS access needed\nüïí Time: ${new Date().toLocaleString()}\nüë§ User: SOS Guardian User\n\nUser needs emergency assistance!`;
                    const encodedMessage = encodeURIComponent(fallbackMessage);
                    const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
                    window.open(whatsappUrl, '_blank');
                    showNotification('üì± Opening WhatsApp (no location)', 'warning');
                }
            );
        }
        
        function shareLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude.toFixed(6);
                        const lng = position.coords.longitude.toFixed(6);
                        const mapsUrl = `https://www.google.com/maps?q=${lat},${lng}`;
                        
                        // Create share interface
                        const sharePanel = document.createElement('div');
                        sharePanel.innerHTML = `
                            <div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:25px;border-radius:15px;z-index:10001;max-width:400px;width:90%;color:#333;box-shadow:0 20px 60px rgba(0,0,0,0.4);">
                                <h3 style="color:#f44336;margin-top:0;">üìç Share Your Location</h3>
                                <p style="color:#666;margin:15px 0;">
                                    <strong>Coordinates:</strong> ${lat}, ${lng}<br>
                                    <strong>Time:</strong> ${new Date().toLocaleString()}
                                </p>
                                <div style="margin:20px 0;">
                                    <button onclick="window.open('${mapsUrl}', '_blank')" style="background:#4285F4;color:white;border:none;padding:12px;width:100%;border-radius:8px;margin:5px 0;">
                                        <i class="fas fa-map"></i> Open in Google Maps
                                    </button>
                                    <button onclick="navigator.clipboard.writeText('${lat}, ${lng}'); alert('Coordinates copied!');" style="background:#666;color:white;border:none;padding:12px;width:100%;border-radius:8px;margin:5px 0;">
                                        <i class="fas fa-copy"></i> Copy Coordinates
                                    </button>
                                </div>
                                <button onclick="this.parentElement.remove(); document.body.lastElementChild.remove();" style="background:#f44336;color:white;border:none;padding:12px;width:100%;border-radius:8px;">
                                    Close
                                </button>
                            </div>
                            <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:10000;"></div>
                        `;
                        
                        document.body.appendChild(sharePanel);
                    },
                    () => {
                        showNotification('üìç GPS access denied', 'error');
                    }
                );
            } else {
                showNotification('üìç Geolocation not supported', 'error');
            }
        }
        
        function capturePhoto() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showNotification('üì∏ Camera not available on this device', 'error');
                return;
            }
            
            navigator.mediaDevices.getUserMedia({ video: true })
                .then((stream) => {
                    const cameraUI = document.createElement('div');
                    cameraUI.innerHTML = `
                        <div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#111;padding:20px;border-radius:15px;z-index:10001;max-width:500px;width:95%;">
                            <h3 style="color:white;text-align:center;margin:0 0 15px 0;">üì∏ Emergency Photo</h3>
                            <video id="liveCamera" autoplay style="width:100%;border-radius:10px;"></video>
                            <div style="text-align:center;margin:20px 0;">
                                <button onclick="takePhotoSnapshot()" style="background:#f44336;color:white;border:none;padding:15px 30px;border-radius:50px;font-size:16px;margin:5px;">
                                    üì∏ Capture Photo
                                </button>
                                <button onclick="closeCamera()" style="background:#666;color:white;border:none;padding:15px 25px;border-radius:8px;margin:5px;">
                                    Cancel
                                </button>
                            </div>
                        </div>
                        <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:10000;"></div>
                    `;
                    
                    document.body.appendChild(cameraUI);
                    const video = document.getElementById('liveCamera');
                    video.srcObject = stream;
                    window.currentCameraStream = stream;
                })
                .catch(() => {
                    showNotification('üì∏ Camera permission denied', 'error');
                });
        }
        
        function takePhotoSnapshot() {
            const video = document.getElementById('liveCamera');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const photoData = canvas.toDataURL('image/jpeg');
            closeCamera();
            
            // Save photo
            const link = document.createElement('a');
            link.download = `sos-emergency-${Date.now()}.jpg`;
            link.href = photoData;
            link.click();
            
            showNotification('üì∏ Photo saved to device', 'success');
        }
        
        function closeCamera() {
            if (window.currentCameraStream) {
                window.currentCameraStream.getTracks().forEach(track => track.stop());
            }
            
            // Remove camera UI
            document.querySelectorAll('div').forEach(div => {
                if (div.style.position === 'fixed' && div.style.zIndex === '10001') {
                    div.remove();
                }
            });
            
            // Remove overlay
            document.querySelectorAll('div').forEach(div => {
                if (div.style.position === 'fixed' && div.style.zIndex === '10000') {
                    div.remove();
                }
            });
        }
        
        function closeModal() {
            document.getElementById('emergencyModal').style.display = 'none';
            
            // Reset emergency state
            emergencyActive = false;
            shakeCount = 0;
            updateShakeDisplay();
            
            // Reset button
            sosButton.style.background = 'linear-gradient(45deg, #ff3b30, #ff2d55)';
            sosButton.style.animation = 'heartbeat 2s infinite';
            document.getElementById('buttonText').classList.remove('hidden');
            
            // Reset map marker
            if (marker) {
                const normalIcon = L.divIcon({
                    html: '<div style="background:#ff3b30;width:20px;height:20px;border-radius:50%;border:3px solid white;box-shadow:0 0 10px red;"></div>',
                    iconSize: [26, 26],
                    className: 'emergency-marker'
                });
                marker.setIcon(normalIcon);
            }
            
            showNotification('Emergency cancelled. Stay safe!', 'info');
        }
        
        // ========== NOTIFICATION ==========
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer') || (() => {
                const div = document.createElement('div');
                div.id = 'notificationContainer';
                document.body.appendChild(div);
                return div;
            })();
            
            const notification = document.createElement('div');
            notification.className = 'notification';
            
            let icon = '‚ÑπÔ∏è';
            if (type === 'success') icon = '‚úÖ';
            if (type === 'warning') icon = '‚ö†Ô∏è';
            if (type === 'emergency') icon = 'üö®';
            if (type === 'error') icon = '‚ùå';
            
            notification.innerHTML = `${icon} ${message}`;
            
            if (type === 'error') notification.style.borderLeftColor = '#ff3b30';
            if (type === 'success') notification.style.borderLeftColor = '#4CAF50';
            if (type === 'emergency') notification.style.borderLeftColor = '#ff9500';
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.5s ease-out reverse';
                setTimeout(() => notification.remove(), 500);
            }, 4000);
        }
        
        // ========== INITIALIZE EVERYTHING ==========
        window.addEventListener('load', () => {
            // Initialize map first
            initializeMap();
            
            // Get user location
            setTimeout(getLocation, 1000);
            
            // Initialize shake detection
            if (window.DeviceMotionEvent) {
                window.addEventListener('devicemotion', handleShake);
                showNotification('üì± Shake detection activated', 'success');
            } else {
                showNotification('üì± Shake detection not supported', 'warning');
            }
            
            // Show welcome message
            setTimeout(() => {
                showNotification('üá≥üá¨ SOS Guardian Pro DEMO loaded', 'success');
            }, 1500);
        });
        
        // Periodic location updates
        setInterval(() => {
            if (!emergencyActive) {
                getLocation();
            }
        }, 30000);
    </script>
</body>
</html>
