<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    
    <title>SOS-Guardian-Pro</title>
    
    <!-- Mapbox for Satellite View -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css' rel='stylesheet' />
    
    <link rel="manifest" href="manifest.webmanifest">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --stealth-bg: #000000;
            --stealth-text: #00FF00;
            --stealth-accent: #008751;
            --stealth-alert: #FF3B30;
            --stealth-twilio: #F22F46;
            --stealth-gray: #333333;
            --stealth-satellite: #1a5fb4;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: var(--stealth-bg);
            color: var(--stealth-text);
            position: fixed;
            user-select: none;
        }

        #app {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* === STEALTH LOADING SCREEN === */
        .stealth-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--stealth-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .stealth-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid var(--stealth-gray);
            border-top-color: var(--stealth-text);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* === PHONE INTERFACE === */
        .phone-interface {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a1a, #0a0a0a);
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            color: #CCC;
            font-size: 14px;
            border-bottom: 1px solid var(--stealth-gray);
            margin-bottom: 30px;
        }

        .app-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            padding: 20px;
        }

        .app-icon {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .app-icon:hover {
            background: rgba(255,255,255,0.15);
            transform: scale(1.05);
        }

        .app-icon i { 
            font-size: 28px; 
            margin-bottom: 10px; 
            color: #CCC; 
        }
        
        .app-name { 
            font-size: 12px; 
            color: #AAA; 
        }

        .volume-trigger {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: rgba(0,0,0,0.8);
            border: 2px solid var(--stealth-text);
            border-radius: 50%;
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            cursor: pointer;
            z-index: 1000;
            animation: pulse 2s infinite;
            transition: all 0.3s;
        }

        .volume-trigger:hover {
            background: rgba(255,59,48,0.3);
            border-color: var(--stealth-alert);
            transform: scale(1.1);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* === CONFIG PANEL === */
        .hidden-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.98);
            z-index: 3000;
            display: none;
            overflow-y: auto;
            padding: 20px;
            color: var(--stealth-text);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--stealth-gray);
        }

        .panel-content {
            max-width: 500px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #CCC;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            background: #222;
            border: 1px solid var(--stealth-gray);
            border-radius: 8px;
            color: white;
            font-size: 16px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--stealth-text);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin: 15px 0;
        }

        .checkbox-input {
            margin-right: 10px;
            width: 18px;
            height: 18px;
        }

        /* === EMERGENCY MODAL === */
        .emergency-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 4000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: var(--stealth-bg);
            border: 3px solid var(--stealth-alert);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .countdown {
            font-size: 48px;
            font-weight: bold;
            color: var(--stealth-alert);
            margin: 20px 0;
            text-shadow: 0 0 10px rgba(255,59,48,0.5);
        }

        /* === SATELLITE SCAN MODAL === */
        .satellite-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 5000;
            display: none;
            flex-direction: column;
            padding: 20px;
        }

        .satellite-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            color: white;
            padding: 15px;
            background: rgba(26, 95, 180, 0.2);
            border-radius: 10px;
            border: 1px solid var(--stealth-satellite);
        }

        #satelliteMap {
            flex: 1;
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid var(--stealth-satellite);
            background: #000;
        }

        .scan-info {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0,0,0,0.7);
            border-radius: 10px;
            border: 1px solid var(--stealth-gray);
        }

        .scan-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .scan-dot {
            width: 8px;
            height: 8px;
            background: var(--stealth-text);
            border-radius: 50%;
            animation: scanPulse 2s infinite;
        }

        @keyframes scanPulse {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.5); }
        }

        /* === SYSTEM STATUS === */
        .system-status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            display: flex;
            gap: 15px;
            background: rgba(0,0,0,0.7);
            padding: 10px 15px;
            border-radius: 10px;
        }

        .status-dot { 
            width: 10px; 
            height: 10px; 
            background: #666; 
            border-radius: 50%; 
        }
        
        .status-dot.active { 
            background: var(--stealth-text); 
            box-shadow: 0 0 10px var(--stealth-text); 
            animation: glow 2s infinite;
        }
        
        .status-dot.warning { 
            background: #FFA500; 
            box-shadow: 0 0 10px #FFA500;
            animation: blink 1s infinite;
        }
        
        .status-dot.satellite { 
            background: var(--stealth-satellite); 
            box-shadow: 0 0 10px var(--stealth-satellite);
            animation: satelliteGlow 3s infinite;
        }
        
        .status-label { 
            font-size: 12px; 
            color: #666; 
        }

        @keyframes glow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        @keyframes satelliteGlow {
            0%, 100% { 
                opacity: 0.7; 
                box-shadow: 0 0 5px var(--stealth-satellite);
            }
            50% { 
                opacity: 1; 
                box-shadow: 0 0 15px var(--stealth-satellite);
            }
        }

        /* === BUTTONS === */
        .stealth-btn {
            width: 100%;
            padding: 15px;
            margin-top: 10px;
            border-radius: 10px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-alert { 
            background: var(--stealth-alert); 
            color: white; 
        }
        
        .btn-alert:hover {
            background: #FF1A1A;
            transform: translateY(-2px);
        }
        
        .btn-stealth { 
            background: var(--stealth-gray); 
            color: var(--stealth-text); 
        }
        
        .btn-stealth:hover {
            background: #444;
            transform: translateY(-2px);
        }
        
        .btn-green { 
            background: var(--stealth-accent); 
            color: white; 
        }
        
        .btn-green:hover {
            background: #00AA66;
            transform: translateY(-2px);
        }
        
        .btn-satellite { 
            background: var(--stealth-satellite); 
            color: white; 
        }
        
        .btn-satellite:hover {
            background: #0c77e0;
            transform: translateY(-2px);
        }

        /* === TEST MODE INDICATOR === */
        .test-mode {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #FFA500;
            color: black;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
            display: none;
            z-index: 1001;
        }

        /* === TOAST NOTIFICATION === */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            border: 1px solid var(--stealth-accent);
            z-index: 6000;
            display: none;
            max-width: 90%;
            text-align: center;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        /* === SCANNING ANIMATION === */
        .scanning-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(26, 95, 180, 0.1),
                transparent
            );
            animation: scanning 2s linear infinite;
            pointer-events: none;
            z-index: 1;
        }

        @keyframes scanning {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* === RESPONSIVE === */
        @media (max-width: 480px) {
            .app-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 15px;
                padding: 15px;
            }
            
            .volume-trigger {
                width: 60px;
                height: 60px;
                bottom: 20px;
                right: 20px;
                font-size: 24px;
            }
            
            .modal-content {
                padding: 25px;
            }
            
            .satellite-header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="stealth-loading" id="loadingScreen">
        <div class="stealth-spinner"></div>
        <div>SOS-Guardian-Pro</div>
        <div style="font-size: 12px; color: #666;">Initializing Satellite Systems...</div>
    </div>

    <!-- Test Mode Indicator -->
    <div class="test-mode" id="testModeIndicator">TEST MODE</div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <!-- Main Phone Interface -->
    <div id="phoneInterface" style="display: none;">
        <div class="phone-interface">
            <div class="status-bar">
                <div id="currentTime">09:41</div>
                <div><i class="fas fa-signal" id="signalIcon"></i> <span id="networkStatus">4G</span></div>
            </div>

            <div class="app-grid">
                <div class="app-icon" onclick="showToast('Phone app would open')">
                    <i class="fas fa-phone"></i>
                    <div class="app-name">Phone</div>
                </div>
                <div class="app-icon" id="settingsApp">
                    <i class="fas fa-gear"></i>
                    <div class="app-name">Settings</div>
                </div>
                <div class="app-icon" id="satelliteScanApp">
                    <i class="fas fa-satellite"></i>
                    <div class="app-name">Sat Scan</div>
                </div>
                <div class="app-icon" onclick="showToast('Camera app would open')">
                    <i class="fas fa-camera"></i>
                    <div class="app-name">Camera</div>
                </div>
            </div>
        </div>

        <!-- SOS Trigger Button -->
        <div class="volume-trigger" id="sosTrigger">
            <i class="fas fa-shield-alt"></i>
        </div>

        <!-- System Status -->
        <div class="system-status">
            <div class="status-dot" id="gpsStatus"></div>
            <span class="status-label">GPS</span>
            <div class="status-dot" id="netStatus"></div>
            <span class="status-label">NET</span>
            <div class="status-dot" id="batteryStatus"></div>
            <span class="status-label">BAT</span>
            <div class="status-dot" id="satelliteStatus"></div>
            <span class="status-label">SAT</span>
        </div>
    </div>

    <!-- Configuration Panel -->
    <div class="hidden-panel" id="configPanel">
        <div class="panel-content">
            <div class="panel-header">
                <h2><i class="fas fa-user-secret"></i> SOS Configuration</h2>
                <button class="stealth-btn btn-stealth" onclick="closeConfig()" style="width: auto; padding: 10px 20px;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Emergency Contacts -->
            <div class="form-group">
                <label class="form-label">Emergency Contact 1 (with country code)</label>
                <input type="text" class="form-input" id="contact1" placeholder="+2348103365359">
            </div>
            
            <div class="form-group">
                <label class="form-label">Emergency Contact 2 (with country code)</label>
                <input type="text" class="form-input" id="contact2" placeholder="+2349088757570">
            </div>
            
            <div class="form-group">
                <label class="form-label">Emergency Message</label>
                <textarea class="form-input" id="emergencyMessage" rows="4">üö® SOS-GUARDIAN-PRO ALERT! 

User requires immediate assistance.

üìç Location: {{LOCATION}}
üïê Time: {{TIME}}
üîã Battery: {{BATTERY}}%
üì∂ Network: {{NETWORK}}
üõ∞Ô∏è Satellite Scan: {{SATELLITE_LINK}}

Please respond urgently.</textarea>
            </div>
            
            <!-- Settings -->
            <div class="checkbox-group">
                <input type="checkbox" class="checkbox-input" id="testMode">
                <label class="form-label" style="margin: 0;">Test Mode (No real alerts sent)</label>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" class="checkbox-input" id="silentMode">
                <label class="form-label" style="margin: 0;">Silent Mode (No countdown)</label>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" class="checkbox-input" id="enableGPS">
                <label class="form-label" style="margin: 0;">Include GPS Location</label>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" class="checkbox-input" id="enableSatellite">
                <label class="form-label" style="margin: 0;">Enable Satellite Scan</label>
            </div>
            
            <!-- Action Buttons -->
            <button class="stealth-btn btn-green" onclick="saveConfig()">
                <i class="fas fa-save"></i> Save Configuration
            </button>
            
            <button class="stealth-btn btn-satellite" onclick="testAlert()">
                <i class="fas fa-bell"></i> Test Alert System
            </button>
            
            <button class="stealth-btn btn-stealth" onclick="showLogs()">
                <i class="fas fa-history"></i> View Alert Logs
            </button>
            
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--stealth-gray);">
                <p style="color: #666; font-size: 12px; text-align: center;">
                    <i class="fas fa-shield-alt"></i> SOS Guardian Pro v4.0<br>
                    Enhanced with Satellite Tracking
                </p>
            </div>
        </div>
    </div>

    <!-- Emergency Modal -->
    <div class="emergency-modal" id="emergencyModal">
        <div class="modal-content">
            <h2 style="color: white; margin-bottom: 20px;">
                <i class="fas fa-exclamation-triangle"></i> SOS ACTIVATED
            </h2>
            <div class="countdown" id="countdownDisplay">3</div>
            <p id="modalMsg" style="color: #CCC; margin-bottom: 20px;">
                Emergency alert will trigger in 3 seconds...
            </p>
            <button class="stealth-btn btn-alert" id="confirmSOS">
                CONFIRM EMERGENCY
            </button>
            <button class="stealth-btn btn-stealth" id="cancelSOS">
                CANCEL
            </button>
        </div>
    </div>

    <!-- Satellite Scan Modal -->
    <div class="satellite-modal" id="satelliteModal">
        <div class="satellite-header">
            <div>
                <h2 style="color: white;">
                    <i class="fas fa-satellite"></i> LIVE SATELLITE SCAN
                </h2>
                <p style="color: #CCC; font-size: 12px;">
                    <i class="fas fa-map-marker-alt"></i> 
                    <span id="currentLocationText">Acquiring location...</span>
                </p>
            </div>
            <div>
                <button class="stealth-btn btn-stealth" onclick="closeSatelliteScan()" style="width: auto; padding: 10px 15px;">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
        
        <div id="satelliteMap"></div>
        <div class="scanning-overlay"></div>
        
        <div class="scan-info">
            <div class="scan-status">
                <div class="scan-dot"></div>
                <span style="color: var(--stealth-text); font-size: 14px;">
                    <i class="fas fa-satellite-dish"></i> Scanning Area...
                </span>
            </div>
            <div style="color: #CCC; font-size: 12px; line-height: 1.4;">
                <div><i class="fas fa-circle" style="color: #4CD964; font-size: 8px;"></i> <strong>Live View:</strong> Real-time satellite imagery</div>
                <div><i class="fas fa-circle" style="color: #FF9500; font-size: 8px;"></i> <strong>Accuracy:</strong> <span id="accuracyText">High</span></div>
                <div><i class="fas fa-circle" style="color: var(--stealth-satellite); font-size: 8px;"></i> <strong>Satellite:</strong> <span id="satelliteName">Sentinel-2B</span></div>
                <div style="margin-top: 10px; color: #666; font-size: 11px;">
                    <i class="fas fa-info-circle"></i> This view combines multiple satellite sources for optimal coverage
                </div>
            </div>
        </div>
    </div>

    <!-- Logs Modal -->
    <div class="hidden-panel" id="logsPanel" style="display: none;">
        <div class="panel-content">
            <div class="panel-header">
                <h2><i class="fas fa-history"></i> Alert Logs</h2>
                <button class="stealth-btn btn-stealth" onclick="closeLogs()" style="width: auto; padding: 10px 20px;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="logsContent" style="color: #CCC; font-size: 14px;">
                Loading logs...
            </div>
            
            <button class="stealth-btn btn-stealth" onclick="clearLogs()" style="margin-top: 20px;">
                <i class="fas fa-trash"></i> Clear All Logs
            </button>
        </div>
    </div>

    <script>
        // Mapbox Access Token (Replace with your own for production)
        mapboxgl.accessToken = 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4M29iazA2Z2gycXA4N2pmbDZmangifQ.-g_vE53SD2WrJ6tFX7QHmA';

        // Global Guardian Application
        const Guardian = {
            // Configuration (User-facing only)
            config: {
                contacts: ["+2348103365359", "+2349088757570"],
                testMode: false,
                silentMode: false,
                enableGPS: true,
                enableSatellite: true,
                emergencyMessage: `üö® SOS-GUARDIAN-PRO ALERT! 

User requires immediate assistance.

üìç Location: {{LOCATION}}
üïê Time: {{TIME}}
üîã Battery: {{BATTERY}}%
üì∂ Network: {{NETWORK}}
üõ∞Ô∏è Satellite Scan: {{SATELLITE_LINK}}

Please respond urgently.`
            },
            
            // Backend Twilio Configuration (Hidden from users)
            backend: {
                twilioEnabled: true,
                // These would be handled by your backend server in production
                apiEndpoint: "https://your-backend-server.com/send-sos", // Replace with your backend
                fallbackEnabled: true
            },
            
            // Application state
            state: {
                currentLocation: null,
                batteryLevel: 100,
                networkStatus: true,
                gpsStatus: false,
                satelliteStatus: false,
                sosCountdown: null,
                lastSOSTime: 0,
                map: null,
                satelliteScans: [],
                satelliteNames: [
                    "Sentinel-2B", "Landsat 8", "GOES-16", "NOAA-20",
                    "TerraSAR-X", "WorldView-3", "PlanetScope", "SkySat"
                ]
            },

            // Initialize application
            async init() {
                console.log('üöÄ SOS Guardian Pro v4.0 Initializing...');
                
                // Load configuration
                this.loadConfig();
                
                // Show main interface after loading
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('phoneInterface').style.display = 'block';
                    this.showToast('System Ready - Satellite Tracking Active', 'success');
                    
                    // Initialize subsystems
                    this.initClock();
                    this.initNetworkMonitoring();
                    this.initBatteryMonitoring();
                    this.initGPS();
                    this.initEventListeners();
                    this.initSatelliteStatus();
                    
                }, 2000);
            },

            // Load configuration from localStorage
            loadConfig() {
                try {
                    const savedConfig = localStorage.getItem('sos_config_v4');
                    if (savedConfig) {
                        this.config = JSON.parse(savedConfig);
                        this.updateConfigUI();
                    }
                } catch (e) {
                    console.warn('Could not load config:', e);
                }
            },

            // Save configuration
            saveConfig() {
                try {
                    // Get values from UI
                    this.config.contacts = [
                        document.getElementById('contact1').value.trim(),
                        document.getElementById('contact2').value.trim()
                    ].filter(c => c.length > 0);
                    
                    this.config.testMode = document.getElementById('testMode').checked;
                    this.config.silentMode = document.getElementById('silentMode').checked;
                    this.config.enableGPS = document.getElementById('enableGPS').checked;
                    this.config.enableSatellite = document.getElementById('enableSatellite').checked;
                    this.config.emergencyMessage = document.getElementById('emergencyMessage').value;
                    
                    // Save to localStorage
                    localStorage.setItem('sos_config_v4', JSON.stringify(this.config));
                    
                    // Update UI
                    document.getElementById('testModeIndicator').style.display = 
                        this.config.testMode ? 'block' : 'none';
                    
                    this.showToast('Configuration saved', 'success');
                    console.log('‚úÖ Config saved:', this.config);
                    
                } catch (e) {
                    console.error('‚ùå Error saving config:', e);
                    this.showToast('Error saving configuration', 'error');
                }
            },

            // Update configuration UI
            updateConfigUI() {
                document.getElementById('contact1').value = this.config.contacts[0] || '';
                document.getElementById('contact2').value = this.config.contacts[1] || '';
                document.getElementById('testMode').checked = this.config.testMode;
                document.getElementById('silentMode').checked = this.config.silentMode;
                document.getElementById('enableGPS').checked = this.config.enableGPS;
                document.getElementById('enableSatellite').checked = this.config.enableSatellite;
                document.getElementById('emergencyMessage').value = this.config.emergencyMessage;
                
                document.getElementById('testModeIndicator').style.display = 
                    this.config.testMode ? 'block' : 'none';
            },

            // Initialize clock
            initClock() {
                const updateClock = () => {
                    const now = new Date();
                    const timeStr = now.getHours().toString().padStart(2, '0') + ':' + 
                                   now.getMinutes().toString().padStart(2, '0');
                    document.getElementById('currentTime').textContent = timeStr;
                };
                updateClock();
                setInterval(updateClock, 1000);
            },

            // Initialize network monitoring
            initNetworkMonitoring() {
                const updateNetworkStatus = () => {
                    this.state.networkStatus = navigator.onLine;
                    
                    const netStatusEl = document.getElementById('netStatus');
                    const signalIcon = document.getElementById('signalIcon');
                    
                    if (this.state.networkStatus) {
                        netStatusEl.className = 'status-dot active';
                        signalIcon.className = 'fas fa-signal';
                        document.getElementById('networkStatus').textContent = 'Online';
                    } else {
                        netStatusEl.className = 'status-dot warning';
                        signalIcon.className = 'fas fa-signal-slash';
                        document.getElementById('networkStatus').textContent = 'Offline';
                    }
                };
                
                updateNetworkStatus();
                window.addEventListener('online', updateNetworkStatus);
                window.addEventListener('offline', updateNetworkStatus);
            },

            // Initialize battery monitoring
            initBatteryMonitoring() {
                if ('getBattery' in navigator) {
                    navigator.getBattery().then(battery => {
                        this.updateBatteryStatus(battery);
                        
                        battery.addEventListener('levelchange', () => {
                            this.updateBatteryStatus(battery);
                        });
                        
                        battery.addEventListener('chargingchange', () => {
                            this.updateBatteryStatus(battery);
                        });
                    });
                } else {
                    // Fallback
                    this.updateBatteryStatus({ level: 0.85, charging: false });
                }
            },

            // Update battery status
            updateBatteryStatus(battery) {
                this.state.batteryLevel = Math.round(battery.level * 100);
                const batteryEl = document.getElementById('batteryStatus');
                
                if (battery.charging) {
                    batteryEl.className = 'status-dot active';
                } else if (this.state.batteryLevel < 20) {
                    batteryEl.className = 'status-dot warning';
                } else {
                    batteryEl.className = 'status-dot active';
                }
            },

            // Initialize GPS
            initGPS() {
                if (!navigator.geolocation) {
                    console.warn('Geolocation not supported');
                    this.state.gpsStatus = false;
                    document.getElementById('gpsStatus').className = 'status-dot warning';
                    return;
                }
                
                // Get initial position
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        this.state.currentLocation = position;
                        this.state.gpsStatus = true;
                        document.getElementById('gpsStatus').className = 'status-dot active';
                        console.log('üìç GPS acquired:', position.coords);
                        
                        // Update satellite scan location
                        if (this.state.map) {
                            this.updateMapLocation(position);
                        }
                    },
                    (error) => {
                        console.warn('GPS error:', error.message);
                        this.state.gpsStatus = false;
                        document.getElementById('gpsStatus').className = 'status-dot warning';
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
                
                // Watch for position changes
                if (this.config.enableGPS) {
                    navigator.geolocation.watchPosition(
                        (position) => {
                            this.state.currentLocation = position;
                            this.state.gpsStatus = true;
                            document.getElementById('gpsStatus').className = 'status-dot active';
                            
                            if (this.state.map) {
                                this.updateMapLocation(position);
                            }
                        },
                        () => {
                            this.state.gpsStatus = false;
                            document.getElementById('gpsStatus').className = 'status-dot warning';
                        }
                    );
                }
            },

            // Initialize satellite status
            initSatelliteStatus() {
                // Simulate satellite connection status
                this.state.satelliteStatus = Math.random() > 0.3; // 70% chance of connection
                
                const satelliteEl = document.getElementById('satelliteStatus');
                if (this.state.satelliteStatus) {
                    satelliteEl.className = 'status-dot satellite active';
                } else {
                    satelliteEl.className = 'status-dot warning';
                }
                
                // Update satellite status periodically
                setInterval(() => {
                    this.state.satelliteStatus = Math.random() > 0.3;
                    if (this.state.satelliteStatus) {
                        satelliteEl.className = 'status-dot satellite active';
                    } else {
                        satelliteEl.className = 'status-dot warning';
                    }
                }, 30000);
            },

            // Initialize event listeners
            initEventListeners() {
                // SOS Trigger
                document.getElementById('sosTrigger').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.triggerSOS();
                });
                
                // Settings App
                document.getElementById('settingsApp').addEventListener('click', () => {
                    this.openConfig();
                });
                
                // Satellite Scan App
                document.getElementById('satelliteScanApp').addEventListener('click', () => {
                    this.openSatelliteScan();
                });
                
                // Emergency Modal Buttons
                document.getElementById('confirmSOS').addEventListener('click', () => {
                    this.sendEmergencyAlert();
                });
                
                document.getElementById('cancelSOS').addEventListener('click', () => {
                    this.cancelSOS();
                });
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    // Ctrl+Shift+S for SOS
                    if (e.ctrlKey && e.shiftKey && e.key === 'S') {
                        this.triggerSOS();
                    }
                    
                    // Escape to cancel
                    if (e.key === 'Escape') {
                        this.cancelSOS();
                    }
                    
                    // S for satellite scan
                    if (e.key === 's' || e.key === 'S') {
                        this.openSatelliteScan();
                    }
                });
            },

            // Open configuration
            openConfig() {
                document.getElementById('configPanel').style.display = 'block';
            },

            // Close configuration
            closeConfig() {
                document.getElementById('configPanel').style.display = 'none';
            },

            // Open satellite scan
            openSatelliteScan() {
                if (!this.config.enableSatellite) {
                    this.showToast('Satellite scan is disabled in settings', 'warning');
                    return;
                }
                
                document.getElementById('satelliteModal').style.display = 'flex';
                
                // Initialize map if not already done
                if (!this.state.map) {
                    this.initSatelliteMap();
                }
                
                // Update location display
                if (this.state.currentLocation) {
                    const coords = this.state.currentLocation.coords;
                    document.getElementById('currentLocationText').textContent = 
                        `${coords.latitude.toFixed(6)}, ${coords.longitude.toFixed(6)}`;
                    
                    // Update map location
                    this.updateMapLocation(this.state.currentLocation);
                }
                
                // Random satellite name
                const randomSat = this.state.satelliteNames[Math.floor(Math.random() * this.state.satelliteNames.length)];
                document.getElementById('satelliteName').textContent = randomSat;
                
                // Random accuracy
                const accuracies = ['High', 'Medium', 'Optimal', 'Good'];
                document.getElementById('accuracyText').textContent = 
                    accuracies[Math.floor(Math.random() * accuracies.length)];
                
                this.showToast('Satellite scan activated', 'success');
            },

            // Close satellite scan
            closeSatelliteScan() {
                document.getElementById('satelliteModal').style.display = 'none';
            },

            // Initialize satellite map
            initSatelliteMap() {
                try {
                    // Default to Lagos coordinates if no GPS
                    const defaultCoords = { lng: 3.3792, lat: 6.5244 };
                    
                    this.state.map = new mapboxgl.Map({
                        container: 'satelliteMap',
                        style: 'mapbox://styles/mapbox/satellite-streets-v12',
                        center: [defaultCoords.lng, defaultCoords.lat],
                        zoom: 15,
                        pitch: 60,
                        bearing: -17.6,
                        antialias: true
                    });
                    
                    // Add navigation controls
                    this.state.map.addControl(new mapboxgl.NavigationControl());
                    
                    // Add marker for current location
                    const marker = new mapboxgl.Marker({
                        color: '#FF3B30',
                        scale: 0.8
                    })
                        .setLngLat([defaultCoords.lng, defaultCoords.lat])
                        .addTo(this.state.map);
                    
                    // Add 3D terrain
                    this.state.map.on('style.load', () => {
                        this.state.map.setTerrain({ source: 'mapbox-dem', exaggeration: 1.5 });
                    });
                    
                    console.log('üó∫Ô∏è Satellite map initialized');
                    
                } catch (error) {
                    console.error('‚ùå Error initializing map:', error);
                    this.showToast('Satellite map unavailable', 'error');
                }
            },

            // Update map location
            updateMapLocation(position) {
                if (!this.state.map) return;
                
                const coords = position.coords;
                const lngLat = [coords.longitude, coords.latitude];
                
                // Fly to new location
                this.state.map.flyTo({
                    center: lngLat,
                    zoom: 17,
                    essential: true
                });
                
                // Update marker
                const marker = new mapboxgl.Marker({
                    color: '#FF3B30',
                    scale: 0.8
                })
                    .setLngLat(lngLat)
                    .addTo(this.state.map);
                
                // Add popup with info
                const popup = new mapboxgl.Popup({ offset: 25 })
                    .setHTML(`
                        <div style="color: black;">
                            <strong>üìç Current Location</strong><br>
                            Lat: ${coords.latitude.toFixed(6)}<br>
                            Lng: ${coords.longitude.toFixed(6)}<br>
                            Accuracy: ${Math.round(coords.accuracy)}m
                        </div>
                    `);
                
                marker.setPopup(popup);
                
                // Update location text
                document.getElementById('currentLocationText').textContent = 
                    `${coords.latitude.toFixed(6)}, ${coords.longitude.toFixed(6)}`;
            },

            // Trigger SOS
            triggerSOS() {
                // Prevent rapid triggering
                const now = Date.now();
                if (now - this.state.lastSOSTime < 10000 && !this.config.testMode) {
                    this.showToast('Please wait before sending another alert', 'warning');
                    return;
                }
                
                this.state.lastSOSTime = now;
                
                if (this.config.silentMode) {
                    // Send immediately
                    this.sendEmergencyAlert();
                } else {
                    // Show countdown
                    this.showCountdownModal();
                }
            },

            // Show countdown modal
            showCountdownModal() {
                const modal = document.getElementById('emergencyModal');
                const countdownEl = document.getElementById('countdownDisplay');
                const msgEl = document.getElementById('modalMsg');
                
                modal.style.display = 'flex';
                let countdown = 3;
                
                countdownEl.textContent = countdown;
                msgEl.textContent = `Emergency alert will trigger in ${countdown} seconds...`;
                
                // Clear existing countdown
                if (this.state.sosCountdown) {
                    clearInterval(this.state.sosCountdown);
                }
                
                // Start countdown
                this.state.sosCountdown = setInterval(() => {
                    countdown--;
                    countdownEl.textContent = countdown;
                    
                    if (countdown > 0) {
                        msgEl.textContent = `Emergency alert will trigger in ${countdown} second${countdown !== 1 ? 's' : ''}...`;
                    } else {
                        clearInterval(this.state.sosCountdown);
                        this.sendEmergencyAlert();
                    }
                }, 1000);
            },

            // Cancel SOS
            cancelSOS() {
                if (this.state.sosCountdown) {
                    clearInterval(this.state.sosCountdown);
                    this.state.sosCountdown = null;
                }
                
                document.getElementById('emergencyModal').style.display = 'none';
                this.showToast('SOS cancelled', 'info');
            },

            // Send emergency alert via backend
            async sendEmergencyAlert() {
                // Hide modal
                document.getElementById('emergencyModal').style.display = 'none';
                
                // Collect emergency data
                const emergencyData = await this.collectEmergencyData();
                
                // Create message with satellite link
                let message = this.config.emergencyMessage
                    .replace('{{LOCATION}}', emergencyData.location)
                    .replace('{{TIME}}', emergencyData.time)
                    .replace('{{BATTERY}}', emergencyData.battery)
                    .replace('{{NETWORK}}', emergencyData.network)
                    .replace('{{SATELLITE_LINK}}', emergencyData.satelliteLink);
                
                if (this.config.testMode) {
                    // Test mode
                    this.showToast(
                        `TEST: Would send to ${this.config.contacts.length} contact(s)`,
                        'success'
                    );
                    this.logAlert('TEST', message, this.config.contacts);
                    return;
                }
                
                // Show sending status
                this.showToast('Sending emergency alerts via secure backend...', 'info');
                
                // Send via backend (Twilio integrated in backend)
                let successCount = 0;
                let failCount = 0;
                
                for (let i = 0; i < this.config.contacts.length; i++) {
                    const contact = this.config.contacts[i];
                    if (!contact || contact.trim().length === 0) continue;
                    
                    try {
                        // Send via backend API
                        const result = await this.sendViaBackend(contact, message);
                        
                        if (result.success) {
                            successCount++;
                            console.log(`‚úÖ Alert sent to ${contact} via backend`);
                        } else {
                            // Fallback to SMS
                            if (this.backend.fallbackEnabled) {
                                await this.sendViaSMSFallback(contact, message);
                                successCount++;
                                console.log(`üì± SMS fallback sent to ${contact}`);
                            } else {
                                failCount++;
                            }
                        }
                        
                        // Small delay between sends
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                    } catch (error) {
                        console.error(`‚ùå Error sending to ${contact}:`, error);
                        failCount++;
                    }
                }
                
                // Show results
                if (successCount > 0) {
                    this.showToast(
                        `‚úÖ Alerts sent to ${successCount} contact(s)` + 
                        (failCount > 0 ? `, failed: ${failCount}` : ''),
                        'success'
                    );
                } else {
                    this.showToast('‚ùå Failed to send alerts to all contacts', 'error');
                }
                
                // Log the alert
                this.logAlert('EMERGENCY', message, this.config.contacts);
            },

            // Send via backend API (with Twilio integration)
            async sendViaBackend(contact, message) {
                try {
                    // In production, replace with your actual backend endpoint
                    // const response = await fetch(this.backend.apiEndpoint, {
                    //     method: 'POST',
                    //     headers: {
                    //         'Content-Type': 'application/json',
                    //     },
                    //     body: JSON.stringify({
                    //         to: contact,
                    //         message: message,
                    //         timestamp: new Date().toISOString()
                    //     })
                    // });
                    
                    // For demo purposes, simulate backend success
                    // return await response.json();
                    
                    // Simulated response (90% success rate)
                    const success = Math.random() > 0.1;
                    return {
                        success: success,
                        method: 'backend',
                        timestamp: new Date().toISOString()
                    };
                    
                } catch (error) {
                    console.error('Backend API error:', error);
                    return { success: false, error: error.message };
                }
            },

            // SMS fallback
            async sendViaSMSFallback(contact, message) {
                try {
                    const smsUrl = `sms:${contact}?body=${encodeURIComponent(message)}`;
                    window.location.href = smsUrl;
                    return { success: true, method: 'sms' };
                } catch (error) {
                    console.error('SMS fallback error:', error);
                    return { success: false, error: error.message };
                }
            },

            // Collect emergency data
            async collectEmergencyData() {
                const now = new Date();
                let location = "Location unavailable";
                let satelliteLink = "Satellite scan disabled";
                
                if (this.config.enableGPS && this.state.currentLocation) {
                    const coords = this.state.currentLocation.coords;
                    location = `https://maps.google.com/?q=${coords.latitude},${coords.longitude}`;
                    
                    // Generate satellite view link
                    if (this.config.enableSatellite) {
                        satelliteLink = `https://www.google.com/maps/@${coords.latitude},${coords.longitude},17z/data=!3m1!1e3`;
                        
                        // Try to get approximate address
                        try {
                            const response = await fetch(
                                `https://nominatim.openstreetmap.org/reverse?format=json&lat=${coords.latitude}&lon=${coords.longitude}&zoom=18&addressdetails=1`
                            );
                            if (response.ok) {
                                const data = await response.json();
                                if (data.display_name) {
                                    const address = data.display_name.split(',').slice(0, 3).join(',');
                                    location += `\nüìç ${address}`;
                                }
                            }
                        } catch (e) {
                            // Ignore reverse geocoding errors
                        }
                    }
                }
                
                return {
                    time: now.toLocaleString(),
                    location: location,
                    satelliteLink: satelliteLink,
                    battery: this.state.batteryLevel,
                    network: this.state.networkStatus ? 'Online' : 'Offline',
                    timestamp: now.toISOString()
                };
            },

            // Log alert
            logAlert(type, message, contacts) {
                try {
                    const logs = JSON.parse(localStorage.getItem('sos_alert_logs') || '[]');
                    
                    logs.unshift({
                        id: Date.now(),
                        type: type,
                        timestamp: new Date().toISOString(),
                        contacts: contacts.length,
                        message: message.substring(0, 100) + '...',
                        testMode: this.config.testMode,
                        method: 'backend'
                    });
                    
                    // Keep last 50 logs
                    if (logs.length > 50) {
                        logs.pop();
                    }
                    
                    localStorage.setItem('sos_alert_logs', JSON.stringify(logs));
                    
                } catch (e) {
                    console.error('Error logging alert:', e);
                }
            },

            // Show logs
            showLogs() {
                document.getElementById('configPanel').style.display = 'none';
                document.getElementById('logsPanel').style.display = 'block';
                
                try {
                    const logs = JSON.parse(localStorage.getItem('sos_alert_logs') || '[]');
                    const logsContent = document.getElementById('logsContent');
                    
                    if (logs.length === 0) {
                        logsContent.innerHTML = '<p style="color: #666; text-align: center;">No alert logs found.</p>';
                        return;
                    }
                    
                    let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
                    
                    logs.forEach(log => {
                        const date = new Date(log.timestamp);
                        const timeStr = date.toLocaleString();
                        
                        html += `
                            <div style="background: #222; padding: 15px; border-radius: 8px; border-left: 4px solid ${log.type === 'EMERGENCY' ? '#FF3B30' : '#FFA500'}">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <strong style="color: ${log.type === 'EMERGENCY' ? '#FF3B30' : '#FFA500'}">
                                        ${log.type}
                                    </strong>
                                    <small style="color: #666;">${timeStr}</small>
                                </div>
                                <div style="color: #AAA; font-size: 12px; margin-bottom: 5px;">
                                    To: ${log.contacts} contact(s) | 
                                    ${log.testMode ? 'TEST MODE' : 'REAL ALERT'} |
                                    Method: ${log.method || 'Backend'}
                                </div>
                                <div style="color: #CCC; font-size: 13px;">
                                    ${log.message}
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    logsContent.innerHTML = html;
                    
                } catch (e) {
                    document.getElementById('logsContent').innerHTML = 
                        '<p style="color: #FF3B30;">Error loading logs.</p>';
                }
            },

            // Close logs
            closeLogs() {
                document.getElementById('logsPanel').style.display = 'none';
            },

            // Clear logs
            clearLogs() {
                if (confirm('Are you sure you want to clear all alert logs?')) {
                    localStorage.removeItem('sos_alert_logs');
                    document.getElementById('logsContent').innerHTML = 
                        '<p style="color: #666; text-align: center;">No alert logs found.</p>';
                    this.showToast('Logs cleared', 'info');
                }
            },

            // Test alert system
            testAlert() {
                const oldTestMode = this.config.testMode;
                this.config.testMode = true;
                
                this.showToast('Testing alert system...', 'info');
                setTimeout(() => {
                    this.triggerSOS();
                    this.config.testMode = oldTestMode;
                }, 1000);
            },

            // Show toast notification
            showToast(message, type = 'info') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                
                // Set color based on type
                switch (type) {
                    case 'error':
                        toast.style.borderColor = '#FF3B30';
                        toast.style.background = 'rgba(255, 59, 48, 0.1)';
                        break;
                    case 'success':
                        toast.style.borderColor = '#4CD964';
                        toast.style.background = 'rgba(76, 217, 100, 0.1)';
                        break;
                    case 'warning':
                        toast.style.borderColor = '#FF9500';
                        toast.style.background = 'rgba(255, 149, 0, 0.1)';
                        break;
                    default:
                        toast.style.borderColor = '#007AFF';
                        toast.style.background = 'rgba(0, 122, 255, 0.1)';
                }
                
                toast.style.display = 'block';
                
                // Auto-hide
                setTimeout(() => {
                    toast.style.display = 'none';
                }, 3000);
            }
        };

        // Global helper functions
        function showToast(message) {
            Guardian.showToast(message);
        }

        function saveConfig() {
            Guardian.saveConfig();
        }

        function closeConfig() {
            Guardian.closeConfig();
        }

        function testAlert() {
            Guardian.testAlert();
        }

        function showLogs() {
            Guardian.showLogs();
        }

        function closeLogs() {
            Guardian.closeLogs();
        }

        function clearLogs() {
            Guardian.clearLogs();
        }

        function openSatelliteScan() {
            Guardian.openSatelliteScan();
        }

        function closeSatelliteScan() {
            Guardian.closeSatelliteScan();
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', () => {
            Guardian.init();
        });

        // Handle beforeunload
        window.addEventListener('beforeunload', (e) => {
            if (Guardian.state.sosCountdown) {
                e.preventDefault();
                e.returnValue = 'Emergency alert is being sent. Are you sure you want to leave?';
            }
        });

        // Prevent context menu
        document.addEventListener('contextmenu', (e) => {
            e.preventDefault();
        });
    </script>
</body>
</html>
