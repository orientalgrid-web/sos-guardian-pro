<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculator</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <style>
        /* ========== CALCULATOR DISGUISE ========== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .calculator {
            background: #2c3e50;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
            overflow: hidden;
        }
        
        .calculator-display {
            background: #1a252f;
            color: white;
            padding: 30px 20px;
            text-align: right;
            font-size: 2.5em;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .calculator-display .result {
            font-size: 2em;
            font-weight: 300;
        }
        
        .calculator-display .equation {
            font-size: 0.8em;
            opacity: 0.7;
            margin-bottom: 5px;
        }
        
        .calculator-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1px;
            background: #34495e;
        }
        
        .calculator-btn {
            background: #2c3e50;
            border: none;
            color: white;
            font-size: 1.2em;
            padding: 25px 0;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .calculator-btn:hover {
            background: #1a252f;
        }
        
        .calculator-btn:active {
            background: #16a085;
        }
        
        .calculator-btn.operator {
            background: #3498db;
        }
        
        .calculator-btn.operator:hover {
            background: #2980b9;
        }
        
        .calculator-btn.equals {
            background: #e74c3c;
            grid-column: span 2;
        }
        
        .calculator-btn.equals:hover {
            background: #c0392b;
        }
        
        .calculator-btn.clear {
            background: #e67e22;
        }
        
        .calculator-btn.clear:hover {
            background: #d35400;
        }
        
        /* ========== SOS INTERFACE (Hidden) ========== */
        .sos-interface {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0c0e2a;
            z-index: 1000;
            overflow-y: auto;
            color: white;
        }
        
        .sos-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .sos-header {
            background: linear-gradient(90deg, #008751 0%, #00A859 100%);
            padding: 25px 30px;
            border-radius: 20px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 15px 35px rgba(0, 135, 81, 0.3);
        }
        
        .emergency-section {
            text-align: center;
            margin: 30px 0;
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 25px;
        }
        
        .emergency-btn {
            background: linear-gradient(45deg, #ff3b30, #ff2d55);
            color: white;
            border: none;
            width: 250px;
            height: 250px;
            border-radius: 50%;
            margin: 0 auto 20px;
            cursor: pointer;
            font-size: 24px;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 20px 40px rgba(255, 59, 48, 0.4);
            animation: heartbeat 2s infinite;
        }
        
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* ========== MAP TRACKING ========== */
        .map-container {
            height: 500px;
            border-radius: 20px;
            overflow: hidden;
            margin: 30px 0;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .map-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 15px;
            z-index: 1001;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .tracking-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .tracking-btn {
            background: #008751;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            flex: 1;
            min-width: 140px;
        }
        
        .tracking-btn:hover {
            background: #00A859;
        }
        
        .tracking-btn.stop {
            background: #ff3b30;
        }
        
        .tracking-btn.stop:hover {
            background: #ff2d55;
        }
        
        .route-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 15px;
            z-index: 1001;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* ========== HIDDEN MAP MODE ========== */
        .hidden-map-mode {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0c0e2a;
            z-index: 10000;
        }
        
        .hidden-map-header {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 15px;
            z-index: 10001;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }
        
        .hidden-map-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 10001;
        }
        
        .hidden-map-btn {
            background: #008751;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            flex: 1;
        }
        
        #hiddenMap {
            width: 100%;
            height: 100%;
        }
        
        /* ========== MODALS ========== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1001;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: #1a1f3a;
            width: 90%;
            max-width: 500px;
            border-radius: 25px;
            padding: 40px;
            text-align: center;
            border: 2px solid rgba(255, 59, 48, 0.5);
        }
        
        /* ========== SETTINGS PANEL ========== */
        .settings-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            padding: 15px;
            border-radius: 15px;
            z-index: 999;
            min-width: 200px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .settings-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 5px 0;
            width: 100%;
            cursor: pointer;
        }
        
        /* ========== PAYMENT SECTION ========== */
        .payment-section {
            background: rgba(255, 215, 0, 0.1);
            border-radius: 20px;
            padding: 30px;
            margin-top: 40px;
            border: 2px solid #FFD700;
        }
        
        .plan-card {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            border: 2px solid #FFD700;
        }
        
        .plan-price {
            font-size: 3rem;
            font-weight: 800;
            color: white;
            margin-bottom: 10px;
        }
        
        .buy-btn {
            background: linear-gradient(45deg, #008751, #00A859);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 15px;
        }
        
        .notification {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            z-index: 1002;
            max-width: 350px;
            animation: slideIn 0.5s ease-out;
            border-left: 5px solid #008751;
        }
        
        @keyframes slideIn {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .hidden { display: none; }
        
        /* ========== FORMS ========== */
        .form-group {
            margin: 20px 0;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #00ff88;
        }
        
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #008751;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        /* ========== RESPONSIVE ========== */
        @media (max-width: 768px) {
            .emergency-btn { width: 200px; height: 200px; font-size: 20px; }
            .map-container { height: 400px; }
            .settings-panel { bottom: 10px; right: 10px; left: 10px; width: auto; }
            .tracking-controls { flex-direction: column; }
            .tracking-btn { width: 100%; }
        }
    </style>
</head>
<body>
    <!-- ========== CALCULATOR DISGUISE ========== -->
    <div class="calculator" id="calculator">
        <div class="calculator-display">
            <div class="equation" id="equation">0</div>
            <div class="result" id="result">0</div>
        </div>
        <div class="calculator-buttons">
            <button class="calculator-btn clear" onclick="clearDisplay()">C</button>
            <button class="calculator-btn operator" onclick="appendOperator('+')">+</button>
            <button class="calculator-btn operator" onclick="appendOperator('-')">-</button>
            <button class="calculator-btn operator" onclick="appendOperator('*')">√ó</button>
            <button class="calculator-btn" onclick="appendNumber('7')">7</button>
            <button class="calculator-btn" onclick="appendNumber('8')">8</button>
            <button class="calculator-btn" onclick="appendNumber('9')">9</button>
            <button class="calculator-btn operator" onclick="appendOperator('/')">√∑</button>
            <button class="calculator-btn" onclick="appendNumber('4')">4</button>
            <button class="calculator-btn" onclick="appendNumber('5')">5</button>
            <button class="calculator-btn" onclick="appendNumber('6')">6</button>
            <button class="calculator-btn" onclick="appendOperator('.')">.</button>
            <button class="calculator-btn" onclick="appendNumber('1')">1</button>
            <button class="calculator-btn" onclick="appendNumber('2')">2</button>
            <button class="calculator-btn" onclick="appendNumber('3')">3</button>
            <button class="calculator-btn equals" onclick="calculate()" onmousedown="holdForEmergency()" onmouseup="releaseHold()" ontouchstart="holdForEmergency()" ontouchend="releaseHold()">=</button>
            <button class="calculator-btn" onclick="appendNumber('0')">0</button>
            <button class="calculator-btn" onclick="toggleSign()">¬±</button>
        </div>
    </div>
    
    <!-- ========== SOS INTERFACE (Hidden) ========== -->
    <div class="sos-interface" id="sosInterface">
        <div class="sos-container">
            <!-- DEMO WARNING -->
            <div style="background:#ff3b30;color:white;padding:15px;border-radius:15px;margin:20px 0;text-align:center;font-weight:bold;border:2px solid #ff9500;">
                <i class="fas fa-exclamation-triangle"></i> DEMO VERSION - Safe for testing
            </div>
            
            <!-- HEADER -->
            <div class="sos-header">
                <h1><i class="fas fa-shield-alt"></i> SOS GUARDIAN PRO</h1>
                <p>Emergency Safety System for Nigeria</p>
            </div>
            
            <!-- SHAKE DETECTION -->
            <div style="background:rgba(0,0,0,0.3);padding:15px;border-radius:15px;margin:20px auto;max-width:500px;display:flex;align-items:center;justify-content:center;gap:15px;">
                <div id="shakeCount" style="background:#007aff;color:white;width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;">
                    0/6
                </div>
                <div>
                    <span style="color:#ff9500;font-weight:600;">SHAKE TO ACTIVATE:</span> Shake phone 6 times
                </div>
            </div>
            
            <!-- EMERGENCY SECTION -->
            <div class="emergency-section">
                <h2>EMERGENCY SOS</h2>
                <p>Press and hold for 3 seconds or shake phone 6 times</p>
                
                <button class="emergency-btn" id="sosButton" onmousedown="startHoldTimer()" onmouseup="cancelHoldTimer()" ontouchstart="startHoldTimer()" ontouchend="cancelHoldTimer()">
                    <i class="fas fa-bell"></i>
                    <span id="buttonText">EMERGENCY<br>SOS</span>
                    <div id="countdown" class="hidden" style="font-size:50px;font-weight:800;"></div>
                </button>
                
                <p style="color:#ffcc00;">Hold button or shake phone</p>
            </div>
            
            <!-- ROUTE TRACKING SETUP -->
            <div style="background:rgba(0,135,81,0.1);border-radius:20px;padding:30px;margin:30px 0;border:2px solid #008751;">
                <h2 style="color:#00ff88;margin-bottom:20px;"><i class="fas fa-route"></i> Route Tracking Setup</h2>
                
                <div class="form-group">
                    <label for="startLocation"><i class="fas fa-map-pin"></i> Start Location (Current)</label>
                    <input type="text" id="startLocation" placeholder="Click 'Use Current Location'" readonly>
                    <button onclick="useCurrentLocation('start')" style="background:#3498db;color:white;border:none;padding:10px;border-radius:8px;margin-top:10px;width:100%;">
                        <i class="fas fa-location-dot"></i> Use Current Location
                    </button>
                </div>
                
                <div class="form-group">
                    <label for="destination"><i class="fas fa-flag-checkered"></i> Destination Address</label>
                    <input type="text" id="destination" placeholder="Enter your destination address">
                    <button onclick="geocodeDestination()" style="background:#9b59b6;color:white;border:none;padding:10px;border-radius:8px;margin-top:10px;width:100%;">
                        <i class="fas fa-search"></i> Find on Map
                    </button>
                </div>
                
                <div class="form-group">
                    <label for="contact1"><i class="fas fa-phone"></i> Primary Emergency Contact</label>
                    <input type="tel" id="contact1" placeholder="+2348012345678" value="+2348103365359">
                </div>
                
                <div class="form-group">
                    <label for="contact2"><i class="fas fa-phone"></i> Secondary Emergency Contact</label>
                    <input type="tel" id="contact2" placeholder="+2348023456789">
                </div>
                
                <button onclick="saveRouteAndContacts()" style="background:#008751;color:white;border:none;padding:15px 30px;border-radius:10px;width:100%;font-size:1.1rem;cursor:pointer;">
                    <i class="fas fa-save"></i> Save Route & Contacts
                </button>
            </div>
            
            <!-- MAP WITH ROUTE TRACKING -->
            <div class="map-container">
                <div class="map-overlay">
                    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
                        <div>
                            <h3 style="color:#00ff88;margin:0;"><i class="fas fa-map"></i> Route Tracker</h3>
                            <p style="margin:5px 0 0 0;font-size:0.9rem;">Start tracking your journey</p>
                        </div>
                        <div class="tracking-controls">
                            <button class="tracking-btn" onclick="calculateRoute()">
                                <i class="fas fa-route"></i> Calculate Route
                            </button>
                            <button class="tracking-btn" onclick="startTracking()">
                                <i class="fas fa-play"></i> Start Tracking
                            </button>
                            <button class="tracking-btn stop" onclick="stopTracking()">
                                <i class="fas fa-stop"></i> Stop
                            </button>
                            <button class="tracking-btn" onclick="enterHiddenMapMode()">
                                <i class="fas fa-eye-slash"></i> Hide App
                            </button>
                        </div>
                    </div>
                </div>
                <div id="map"></div>
                <div class="route-info hidden" id="routeInfo">
                    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
                        <div>
                            <p style="margin:0;"><i class="fas fa-road"></i> Distance: <span id="routeDistance">--</span></p>
                            <p style="margin:5px 0 0 0;"><i class="fas fa-clock"></i> Time: <span id="routeTime">--</span></p>
                        </div>
                        <div>
                            <p style="margin:0;color:#00ff88;"><i class="fas fa-user-shield"></i> SOS Active</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- PAYMENT SECTION -->
            <div class="payment-section">
                <h2 style="color:#FFD700;margin-bottom:25px;"><i class="fas fa-crown"></i> Activate Premium Protection</h2>
                
                <div class="plan-card">
                    <h3 style="color:#FFD700;font-size:1.5rem;">PREMIUM PLAN</h3>
                    <div class="plan-price">‚Ç¶1,500<span style="font-size:1.5rem;">/month</span></div>
                    
                    <div style="text-align:left;margin:25px 0;">
                        <p><i class="fas fa-check" style="color:#00ff88;"></i> Live Route Tracking</p>
                        <p><i class="fas fa-check" style="color:#00ff88;"></i> Hidden Map Navigation</p>
                        <p><i class="fas fa-check" style="color:#00ff88;"></i> Emergency SOS with Shake</p>
                        <p><i class="fas fa-check" style="color:#00ff88;"></i> Auto Alerts to Contacts</p>
                        <p><i class="fas fa-check" style="color:#00ff88;"></i> Disguised as Calculator</p>
                    </div>
                    
                    <div style="margin:20px 0;padding:20px;background:rgba(255,255,255,0.05);border-radius:10px;">
                        <h4 style="color:#FFD700;margin-bottom:10px;">Bank Transfer Details:</h4>
                        <p><strong>Account Name:</strong> Proto Douglas Ltd</p>
                        <p><strong>Account Number:</strong> 0034133605</p>
                        <p><strong>Bank:</strong> Union Bank</p>
                        <p><strong>Amount:</strong> ‚Ç¶1,500 (Monthly)</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="paymentProof"><i class="fas fa-receipt"></i> Upload Payment Proof</label>
                        <input type="file" id="paymentProof" accept="image/*">
                    </div>
                    
                    <div class="form-group">
                        <label for="subscriberEmail"><i class="fas fa-envelope"></i> Your Email for Activation</label>
                        <input type="email" id="subscriberEmail" placeholder="your@email.com">
                    </div>
                    
                    <button class="buy-btn" onclick="submitPayment()">
                        <i class="fas fa-paper-plane"></i> Submit Payment Proof
                    </button>
                    
                    <p style="margin-top:15px;font-size:0.9rem;opacity:0.8;">
                        After payment, send proof to: support@proto-douglas.com<br>
                        Activation within 24 hours
                    </p>
                </div>
            </div>
            
            <!-- FOOTER -->
            <div style="text-align:center;padding:30px;margin-top:50px;background:rgba(0,0,0,0.3);border-radius:15px;">
                <p><strong>SOS GUARDIAN PRO v2.0 - DEMO MODE</strong></p>
                <p><i class="fas fa-phone"></i> Emergency: 112, 767 | Support: +234 8103365359</p>
                <p>¬© 2024 SOS Guardian Technologies is a product of Proto Douglas Ltd. All data stays on your device.</p>
            </div>
        </div>
    </div>
    
    <!-- ========== HIDDEN MAP MODE ========== -->
    <div class="hidden-map-mode" id="hiddenMapMode">
        <div class="hidden-map-header">
            <h3 style="color:#00ff88;margin:0;"><i class="fas fa-map"></i> Route Navigation</h3>
            <p style="margin:5px 0 0 0;font-size:0.9rem;">
                <span id="hiddenRouteDistance">Distance: --</span> | 
                <span id="hiddenRouteTime">Time: --</span>
            </p>
        </div>
        <div id="hiddenMap"></div>
        <div class="hidden-map-controls">
            <button class="hidden-map-btn" onclick="showFullApp()">
                <i class="fas fa-eye"></i> Show App
            </button>
            <button class="hidden-map-btn" onclick="testEmergencyFromHidden()" style="background:#ff3b30;">
                <i class="fas fa-bell"></i> Emergency SOS
            </button>
            <button class="hidden-map-btn" onclick="exitHiddenMode()" style="background:#666;">
                <i class="fas fa-times"></i> Exit
            </button>
        </div>
    </div>
    
    <!-- ========== SETTINGS PANEL ========== -->
    <div class="settings-panel" id="settingsPanel">
        <button class="settings-btn" onclick="toggleSOSInterface()">
            <i class="fas fa-eye"></i> Show/Hide SOS
        </button>
        <button class="settings-btn" onclick="resetCalculator()">
            <i class="fas fa-calculator"></i> Reset to Calculator
        </button>
        <button class="settings-btn" onclick="testEmergency()">
            <i class="fas fa-bell"></i> Test Emergency
        </button>
    </div>
    
    <!-- ========== EMERGENCY MODAL ========== -->
    <div class="modal" id="emergencyModal">
        <div class="modal-content">
            <div style="font-size:70px;color:#ff3b30;margin-bottom:20px;">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h2 style="color:#ffcc00;">EMERGENCY ACTIVATED!</h2>
            <p style="margin:20px 0;">Sending alerts to your emergency contacts...</p>
            
            <div style="background:rgba(255,59,48,0.1);padding:15px;border-radius:10px;margin:20px 0;text-align:left;">
                <p><i class="fas fa-check-circle" style="color:#00ff88;"></i> Location sent: <span id="locationStatus">Sending...</span></p>
                <p><i class="fas fa-check-circle" style="color:#00ff88;"></i> Route deviation alert: <span id="routeAlertStatus">Monitoring...</span></p>
                <p><i class="fas fa-check-circle" style="color:#00ff88;"></i> WhatsApp alert: <span id="whatsappStatus">Preparing...</span></p>
            </div>
            
            <div style="margin:30px 0;">
                <button onclick="sendEmergencyAlerts()" style="background:#25D366;color:white;border:none;padding:15px;border-radius:10px;margin:5px;width:100%;">
                    <i class="fab fa-whatsapp"></i> Send WhatsApp Alert Now
                </button>
                <button onclick="closeModal()" style="background:#666;color:white;border:none;padding:15px;border-radius:10px;margin:5px;width:100%;">
                    Cancel (False Alarm)
                </button>
            </div>
        </div>
    </div>
    
    <!-- ========== ACTIVATION MODAL ========== -->
    <div class="modal" id="activationModal">
        <div class="modal-content">
            <div style="font-size:70px;color:#FFD700;margin-bottom:20px;">
                <i class="fas fa-crown"></i>
            </div>
            <h2 style="color:#FFD700;">PREMIUM ACTIVATION</h2>
            <p>Your subscription will be activated after payment verification.</p>
            
            <div style="margin:30px 0;">
                <button onclick="checkActivation()" style="background:#008751;color:white;border:none;padding:15px;border-radius:10px;margin:5px;width:100%;">
                    <i class="fas fa-sync"></i> Check Activation Status
                </button>
                <button onclick="closeActivationModal()" style="background:#666;color:white;border:none;padding:15px;border-radius:10px;margin:5px;width:100%;">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script>
        // ========== CALCULATOR FUNCTIONS ==========
        let currentInput = '0';
        let previousInput = '';
        let operation = null;
        let resetScreen = false;
        
        function appendNumber(number) {
            if (currentInput === '0' || resetScreen) {
                currentInput = number;
                resetScreen = false;
            } else {
                currentInput += number;
            }
            updateDisplay();
        }
        
        function appendOperator(op) {
            if (op === '=') {
                calculate();
                return;
            }
            
            if (previousInput !== '' && operation !== null) {
                calculate();
            }
            
            operation = op;
            previousInput = currentInput;
            currentInput = '0';
            updateDisplay();
        }
        
        function calculate() {
            let computation;
            const prev = parseFloat(previousInput);
            const current = parseFloat(currentInput);
            
            if (isNaN(prev) || isNaN(current)) return;
            
            switch (operation) {
                case '+': computation = prev + current; break;
                case '-': computation = prev - current; break;
                case '*': computation = prev * current; break;
                case '/': computation = prev / current; break;
                default: return;
            }
            
            currentInput = computation.toString();
            operation = null;
            previousInput = '';
            resetScreen = true;
            updateDisplay();
        }
        
        function clearDisplay() {
            currentInput = '0';
            previousInput = '';
            operation = null;
            updateDisplay();
        }
        
        function toggleSign() {
            currentInput = (parseFloat(currentInput) * -1).toString();
            updateDisplay();
        }
        
        function updateDisplay() {
            document.getElementById('result').textContent = currentInput;
            document.getElementById('equation').textContent = 
                previousInput + (operation ? ' ' + operation : '');
        }
        
        // ========== SOS EMERGENCY SYSTEM ==========
        let map = null;
        let hiddenMap = null;
        let userLocation = { lat: 6.5244, lng: 3.3792 }; // Lagos
        let startLocation = { lat: null, lng: null };
        let destination = { lat: null, lng: null };
        let destinationAddress = '';
        let routingControl = null;
        let isTracking = false;
        let trackingInterval = null;
        let emergencyActive = false;
        let shakeCount = 0;
        let holdTimer = null;
        let countdownValue = 3;
        let calculatorHoldTimer = null;
        let lastPosition = null;
        
        // ========== DISGUISE FUNCTIONS ==========
        function toggleSOSInterface() {
            const sosInterface = document.getElementById('sosInterface');
            const calculator = document.getElementById('calculator');
            const settingsPanel = document.getElementById('settingsPanel');
            
            if (sosInterface.style.display === 'block') {
                sosInterface.style.display = 'none';
                calculator.style.display = 'block';
                settingsPanel.style.display = 'block';
            } else {
                sosInterface.style.display = 'block';
                calculator.style.display = 'none';
                settingsPanel.style.display = 'none';
                initializeSOS();
            }
        }
        
        function resetCalculator() {
            document.getElementById('sosInterface').style.display = 'none';
            document.getElementById('calculator').style.display = 'block';
            document.getElementById('settingsPanel').style.display = 'block';
        }
        
        function holdForEmergency() {
            calculatorHoldTimer = setTimeout(() => {
                toggleSOSInterface();
                showNotification('üõ°Ô∏è SOS Guardian Pro Activated', 'success');
            }, 3000);
        }
        
        function releaseHold() {
            clearTimeout(calculatorHoldTimer);
        }
        
        // ========== SOS INITIALIZATION ==========
        function initializeSOS() {
            if (!map) {
                initializeMap();
                getCurrentLocation();
            }
            
            loadSavedData();
            
            if (window.DeviceMotionEvent) {
                window.addEventListener('devicemotion', handleShake);
            }
        }
        
        function initializeMap() {
            map = L.map('map').setView([userLocation.lat, userLocation.lng], 14);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19,
            }).addTo(map);
            
            // Add start marker
            startMarker = L.marker([userLocation.lat, userLocation.lng], {
                icon: L.divIcon({
                    html: '<div style="background:#3498db;width:20px;height:20px;border-radius:50%;border:3px solid white;box-shadow:0 0 10px #3498db;"><i class="fas fa-play" style="color:white;font-size:10px;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);"></i></div>',
                    iconSize: [26, 26]
                })
            }).addTo(map).bindPopup('Start Location');
            
            // Initialize hidden map
            hiddenMap = L.map('hiddenMap').setView([userLocation.lat, userLocation.lng], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19,
            }).addTo(hiddenMap);
            
            L.control.scale().addTo(map);
            L.control.scale().addTo(hiddenMap);
        }
        
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        startLocation = { ...userLocation };
                        document.getElementById('startLocation').value = 
                            `${userLocation.lat.toFixed(6)}, ${userLocation.lng.toFixed(6)}`;
                        
                        if (map) {
                            map.setView([userLocation.lat, userLocation.lng], 16);
                            if (startMarker) {
                                startMarker.setLatLng([userLocation.lat, userLocation.lng]);
                            }
                        }
                        
                        showNotification('üìç Current location acquired', 'success');
                    },
                    () => {
                        showNotification('üìç Using default location', 'info');
                        document.getElementById('startLocation').value = 
                            `${userLocation.lat.toFixed(6)}, ${userLocation.lng.toFixed(6)}`;
                        startLocation = { ...userLocation };
                    }
                );
            }
        }
        
        function useCurrentLocation(type) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        if (type === 'start') {
                            startLocation = { lat, lng };
                            document.getElementById('startLocation').value = 
                                `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                            
                            if (map && startMarker) {
                                startMarker.setLatLng([lat, lng]);
                                map.setView([lat, lng], 16);
                            }
                            
                            showNotification('üìç Start location set', 'success');
                        }
                    }
                );
            }
        }
        
        function geocodeDestination() {
            const destinationInput = document.getElementById('destination').value;
            if (!destinationInput) {
                showNotification('Please enter a destination address', 'error');
                return;
            }
            
            showNotification('üîç Searching for destination...', 'info');
            
            // Using Nominatim for geocoding (OpenStreetMap)
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(destinationInput + ', Nigeria')}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        destination = {
                            lat: parseFloat(data[0].lat),
                            lng: parseFloat(data[0].lon)
                        };
                        destinationAddress = data[0].display_name;
                        
                        // Add destination marker
                        if (destinationMarker) {
                            map.removeLayer(destinationMarker);
                        }
                        
                        destinationMarker = L.marker([destination.lat, destination.lng], {
                            icon: L.divIcon({
                                html: '<div style="background:#e74c3c;width:20px;height:20px;border-radius:50%;border:3px solid white;box-shadow:0 0 10px #e74c3c;"><i class="fas fa-flag" style="color:white;font-size:10px;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);"></i></div>',
                                iconSize: [26, 26]
                            })
                        }).addTo(map).bindPopup('Destination: ' + destinationAddress);
                        
                        showNotification('üìç Destination found on map', 'success');
                        
                        // Zoom to show both points
                        const bounds = L.latLngBounds([startLocation.lat, startLocation.lng], [destination.lat, destination.lng]);
                        map.fitBounds(bounds, { padding: [50, 50] });
                    } else {
                        showNotification('Destination not found. Please try a different address.', 'error');
                    }
                })
                .catch(error => {
                    console.error('Geocoding error:', error);
                    showNotification('Error searching destination. Using coordinates.', 'error');
                });
        }
        
        // ========== ROUTE CALCULATION ==========
        function calculateRoute() {
            if (!startLocation.lat || !destination.lat) {
                showNotification('Please set both start and destination locations', 'error');
                return;
            }
            
            // Remove existing route if any
            if (routingControl) {
                map.removeControl(routingControl);
            }
            
            // Calculate route using OSRM
            routingControl = L.Routing.control({
                waypoints: [
                    L.latLng(startLocation.lat, startLocation.lng),
                    L.latLng(destination.lat, destination.lng)
                ],
                routeWhileDragging: false,
                showAlternatives: false,
                addWaypoints: false,
                draggableWaypoints: false,
                fitSelectedRoutes: true,
                show: true,
                router: L.Routing.osrmv1({
                    serviceUrl: 'https://router.project-osrm.org/route/v1'
                }),
                createMarker: function() { return null; } // Disable default markers
            }).addTo(map);
            
            routingControl.on('routesfound', function(e) {
                const routes = e.routes;
                if (routes && routes.length > 0) {
                    const route = routes[0];
                    const distance = (route.summary.totalDistance / 1000).toFixed(1);
                    const time = Math.floor(route.summary.totalTime / 60);
                    
                    document.getElementById('routeDistance').textContent = `${distance} km`;
                    document.getElementById('routeTime').textContent = `${time} mins`;
                    document.getElementById('routeInfo').classList.remove('hidden');
                    
                    document.getElementById('hiddenRouteDistance').textContent = `Distance: ${distance} km`;
                    document.getElementById('hiddenRouteTime').textContent = `Time: ${time} mins`;
                    
                    showNotification(`üó∫Ô∏è Route calculated: ${distance} km, ${time} mins`, 'success');
                }
            });
            
            routingControl.on('routingerror', function(e) {
                showNotification('Error calculating route. Please try again.', 'error');
            });
        }
        
        function startTracking() {
            if (!routingControl) {
                showNotification('Please calculate route first', 'error');
                return;
            }
            
            if (isTracking) {
                showNotification('Already tracking', 'info');
                return;
            }
            
            isTracking = true;
            lastPosition = startLocation;
            
            // Start tracking user position
            trackingInterval = setInterval(() => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const currentPos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            
                            // Update position on maps
                            updateUserPosition(currentPos);
                            
                            // Check for route deviation
                            checkRouteDeviation(currentPos);
                        }
                    );
                }
            }, 10000); // Update every 10 seconds
            
            showNotification('üöó Route tracking started', 'success');
        }
        
        function stopTracking() {
            if (isTracking) {
                clearInterval(trackingInterval);
                isTracking = false;
                showNotification('üõë Route tracking stopped', 'info');
            }
        }
        
        let userPositionMarker = null;
        let hiddenUserPositionMarker = null;
        
        function updateUserPosition(position) {
            // Update on main map
            if (!userPositionMarker) {
                userPositionMarker = L.marker([position.lat, position.lng], {
                    icon: L.divIcon({
                        html: '<div style="background:#00ff88;width:15px;height:15px;border-radius:50%;border:2px solid white;box-shadow:0 0 10px #00ff88;"></div>',
                        iconSize: [19, 19]
                    })
                }).addTo(map);
            } else {
                userPositionMarker.setLatLng([position.lat, position.lng]);
            }
            
            // Update on hidden map
            if (!hiddenUserPositionMarker && hiddenMap) {
                hiddenUserPositionMarker = L.marker([position.lat, position.lng], {
                    icon: L.divIcon({
                        html: '<div style="background:#00ff88;width:15px;height:15px;border-radius:50%;border:2px solid white;box-shadow:0 0 10px #00ff88;"></div>',
                        iconSize: [19, 19]
                    })
                }).addTo(hiddenMap);
            } else if (hiddenUserPositionMarker && hiddenMap) {
                hiddenUserPositionMarker.setLatLng([position.lat, position.lng]);
                hiddenMap.setView([position.lat, position.lng], 16);
            }
            
            lastPosition = position;
        }
        
        function checkRouteDeviation(currentPos) {
            // Simple distance check - in production, use proper route matching
            const distanceToStart = calculateDistance(currentPos, startLocation);
            const distanceToDest = calculateDistance(currentPos, destination);
            
            // If user is moving away from route significantly
            if (distanceToStart > 5 && distanceToDest > 5) { // 5km threshold
                document.getElementById('routeAlertStatus').textContent = 'Deviated from route!';
                showNotification('‚ö†Ô∏è You have deviated from your route', 'warning');
            }
        }
        
        function calculateDistance(pos1, pos2) {
            const R = 6371; // Earth's radius in km
            const dLat = (pos2.lat - pos1.lat) * Math.PI / 180;
            const dLon = (pos2.lng - pos1.lng) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(pos1.lat * Math.PI / 180) * Math.cos(pos2.lat * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // ========== HIDDEN MAP MODE ==========
        function enterHiddenMapMode() {
            if (!isTracking) {
                showNotification('Please start tracking first', 'error');
                return;
            }
            
            document.getElementById('sosInterface').style.display = 'none';
            document.getElementById('calculator').style.display = 'none';
            document.getElementById('settingsPanel').style.display = 'none';
            document.getElementById('hiddenMapMode').style.display = 'block';
            
            showNotification('üó∫Ô∏è App hidden. Only map visible.', 'success');
        }
        
        function showFullApp() {
            document.getElementById('hiddenMapMode').style.display = 'none';
            document.getElementById('sosInterface').style.display = 'block';
        }
        
        function exitHiddenMode() {
            document.getElementById('hiddenMapMode').style.display = 'none';
            document.getElementById('calculator').style.display = 'block';
            document.getElementById('settingsPanel').style.display = 'block';
        }
        
        function testEmergencyFromHidden() {
            exitHiddenMode();
            triggerEmergency('hidden_mode');
        }
        
        // ========== SHAKE DETECTION ==========
        let lastAcceleration = { x: null, y: null, z: null };
        let lastShakeTime = 0;
        
        function handleShake(event) {
            const acceleration = event.accelerationIncludingGravity;
            
            if (!lastAcceleration.x) {
                lastAcceleration = { x: acceleration.x, y: acceleration.y, z: acceleration.z };
                return;
            }
            
            const delta = Math.abs(acceleration.x - lastAcceleration.x) + 
                         Math.abs(acceleration.y - lastAcceleration.y) + 
                         Math.abs(acceleration.z - lastAcceleration.z);
            
            if (delta > 15) {
                const now = Date.now();
                if (now - lastShakeTime > 1000) {
                    shakeCount = 0;
                }
                
                shakeCount++;
                lastShakeTime = now;
                
                updateShakeDisplay();
                
                if (shakeCount >= 6) {
                    triggerEmergency('shake');
                }
            }
            
            lastAcceleration = { x: acceleration.x, y: acceleration.y, z: acceleration.z };
        }
        
        function updateShakeDisplay() {
            const shakeElement = document.getElementById('shakeCount');
            if (shakeElement) {
                shakeElement.textContent = `${shakeCount}/6`;
                if (shakeCount >= 6) {
                    shakeElement.style.background = '#ff3b30';
                } else if (shakeCount >= 4) {
                    shakeElement.style.background = '#ff9500';
                }
            }
        }
        
        // ========== EMERGENCY FUNCTIONS ==========
        function startHoldTimer() {
            if (emergencyActive) return;
            
            countdownValue = 3;
            document.getElementById('buttonText').classList.add('hidden');
            document.getElementById('countdown').classList.remove('hidden');
            document.getElementById('countdown').textContent = countdownValue;
            
            holdTimer = setInterval(() => {
                countdownValue--;
                document.getElementById('countdown').textContent = countdownValue;
                
                if (countdownValue <= 0) {
                    clearInterval(holdTimer);
                    triggerEmergency('button');
                }
            }, 1000);
        }
        
        function cancelHoldTimer() {
            if (holdTimer && !emergencyActive) {
                clearInterval(holdTimer);
                document.getElementById('buttonText').classList.remove('hidden');
                document.getElementById('countdown').classList.add('hidden');
            }
        }
        
        function triggerEmergency(source) {
            if (emergencyActive) return;
            
            emergencyActive = true;
            document.getElementById('emergencyModal').style.display = 'flex';
            document.getElementById('buttonText').classList.add('hidden');
            document.getElementById('countdown').classList.add('hidden');
            
            document.getElementById('locationStatus').textContent = 'Acquiring...';
            document.getElementById('routeAlertStatus').textContent = 'Checking...';
            
            showNotification('üö® Emergency activated!', 'emergency');
        }
        
        function sendEmergencyAlerts() {
            const contact1 = document.getElementById('contact1').value;
            const contact2 = document.getElementById('contact2').value;
            const dest = document.getElementById('destination').value;
            
            if (!contact1) {
                showNotification('Please set emergency contacts first', 'error');
                return;
            }
            
            let message = `üö® EMERGENCY ALERT from SOS Guardian Pro!\n\n`;
            message += `üìç Current Location: ${lastPosition.lat.toFixed(6)}, ${lastPosition.lng.toFixed(6)}\n`;
            message += `üó∫Ô∏è Map: https://maps.google.com/?q=${lastPosition.lat},${lastPosition.lng}\n`;
            message += `üïí Time: ${new Date().toLocaleString()}\n`;
            if (dest) {
                message += `üéØ Destination: ${dest}\n`;
            }
            if (isTracking) {
                message += `üöó Status: En route to destination\n`;
            }
            message += `\nüöë USER NEEDS EMERGENCY ASSISTANCE!`;
            
            document.getElementById('locationStatus').textContent = 'Sent ‚úì';
            document.getElementById('routeAlertStatus').textContent = 'Alert sent ‚úì';
            document.getElementById('whatsappStatus').textContent = 'Opening...';
            
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            
            setTimeout(() => {
                document.getElementById('whatsappStatus').textContent = 'Sent ‚úì';
            }, 1000);
            
            showNotification('üì± Emergency alerts sent', 'success');
        }
        
        function closeModal() {
            document.getElementById('emergencyModal').style.display = 'none';
            emergencyActive = false;
            shakeCount = 0;
            updateShakeDisplay();
            document.getElementById('buttonText').classList.remove('hidden');
            showNotification('Emergency cancelled', 'info');
        }
        
        // ========== DATA SAVING ==========
        function saveRouteAndContacts() {
            const contact1 = document.getElementById('contact1').value;
            const contact2 = document.getElementById('contact2').value;
            const dest = document.getElementById('destination').value;
            const start = document.getElementById('startLocation').value;
            
            localStorage.setItem('sos_contact1', contact1);
            localStorage.setItem('sos_contact2', contact2);
            localStorage.setItem('sos_destination', dest);
            localStorage.setItem('sos_start', start);
            
            showNotification('‚úÖ Route & contacts saved', 'success');
        }
        
        function loadSavedData() {
            const contact1 = localStorage.getItem('sos_contact1');
            const contact2 = localStorage.getItem('sos_contact2');
            const dest = localStorage.getItem('sos_destination');
            const start = localStorage.getItem('sos_start');
            
            if (contact1) document.getElementById('contact1').value = contact1;
            if (contact2) document.getElementById('contact2').value = contact2;
            if (dest) document.getElementById('destination').value = dest;
            if (start) document.getElementById('startLocation').value = start;
        }
        
        // ========== PAYMENT & ACTIVATION ==========
        function submitPayment() {
            const email = document.getElementById('subscriberEmail').value;
            const fileInput = document.getElementById('paymentProof');
            
            if (!email || !email.includes('@')) {
                showNotification('Please enter a valid email', 'error');
                return;
            }
            
            if (!fileInput.files.length) {
                showNotification('Please upload payment proof', 'error');
                return;
            }
            
            localStorage.setItem('sos_payment_pending', 'true');
            localStorage.setItem('sos_subscriber_email', email);
            
            document.getElementById('activationModal').style.display = 'flex';
            showNotification('‚úÖ Payment proof submitted. Activation pending.', 'success');
        }
        
        function checkActivation() {
            const isActivated = localStorage.getItem('sos_activated') === 'true';
            
            if (isActivated) {
                showNotification('‚úÖ Your account is activated!', 'success');
                closeActivationModal();
            } else {
                showNotification('‚è≥ Payment verification in progress...', 'info');
                
                setTimeout(() => {
                    const shouldActivate = confirm('Has payment been confirmed? (Bank alert received?)');
                    if (shouldActivate) {
                        localStorage.setItem('sos_activated', 'true');
                        showNotification('üéâ Premium features activated!', 'success');
                        closeActivationModal();
                    }
                }, 1000);
            }
        }
        
        function closeActivationModal() {
            document.getElementById('activationModal').style.display = 'none';
        }
        
        // ========== TEST FUNCTION ==========
        function testEmergency() {
            triggerEmergency('test');
        }
        
        // ========== NOTIFICATION ==========
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            
            let icon = '‚ÑπÔ∏è';
            if (type === 'success') icon = '‚úÖ';
            if (type === 'warning') icon = '‚ö†Ô∏è';
            if (type === 'emergency') icon = 'üö®';
            if (type === 'error') icon = '‚ùå';
            
            notification.innerHTML = `${icon} ${message}`;
            
            if (type === 'error') notification.style.borderLeftColor = '#ff3b30';
            if (type === 'success') notification.style.borderLeftColor = '#4CAF50';
            if (type === 'emergency') notification.style.borderLeftColor = '#ff9500';
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.5s ease-out reverse';
                setTimeout(() => notification.remove(), 500);
            }, 4000);
        }
        
        // ========== INITIALIZATION ==========
        window.addEventListener('load', () => {
            updateDisplay();
            
            if (localStorage.getItem('sos_activated') === 'true') {
                showNotification('‚úÖ SOS Guardian Pro Premium Active', 'success');
            }
            
            setTimeout(() => {
                document.getElementById('settingsPanel').style.display = 'none';
            }, 10000);
        });
    </script>
</body>
</html>
